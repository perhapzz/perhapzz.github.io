<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>golang学习笔记 | perhapzz</title>
<meta name="keywords" content="golang">
<meta name="description" content="Git学习笔记">
<meta name="author" content="">
<link rel="canonical" href="https://perhapzz.github.io/posts/golang/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2c5d624023ca4f39285dc8ad242509c565a0c0e820fc61724b2a58620dfdafbe.css" integrity="sha256-LF1iQCPKTzkoXcitJCUJxWWgwOgg/GFySypYYg39r74=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://perhapzz.github.io/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://perhapzz.github.io/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://perhapzz.github.io/favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://perhapzz.github.io/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://perhapzz.github.io/favicon/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="golang学习笔记" />
<meta property="og:description" content="Git学习笔记" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://perhapzz.github.io/posts/golang/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-17T10:04:52+08:00" />
<meta property="article:modified_time" content="2022-01-17T10:04:52+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="golang学习笔记"/>
<meta name="twitter:description" content="Git学习笔记"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://perhapzz.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "golang学习笔记",
      "item": "https://perhapzz.github.io/posts/golang/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "golang学习笔记",
  "name": "golang学习笔记",
  "description": "Git学习笔记",
  "keywords": [
    "golang"
  ],
  "articleBody": "基础知识 1. 变量定义 var a int // 如果没有赋值，默认为0 var a int = 1 // 声明时赋值 var a = 1 // 声明时赋值 a := 1 2. new 和 make new 的作用是初始化一个指向类型的指针(*T)。使用new函数来分配空间。传递给new函数的是一个类型，不是一个值。返回值是 指向这个新分配的零值的指针\n/** * Definition for singly-linked list. * type ListNode struct { * Val int * Next *ListNode * } */  // 方法一： l := new(ListNode) l.val = val l.Next =  // 方法二： l := \u0026ListNode{  val, next } make 的作用是为 slice，map 或 chan 初始化并返回引用(T)\n3. 变量类型 空值：nil\n整型类型： int(取决于操作系统), int8, int16, int32, int64, uint8, uint16, …\n浮点数类型：float32, float64\n字节类型：byte (等价于uint8)\n字符串类型：string\n布尔值类型：boolean，(true 或 false)\n4. INT_MIN 和 INT_MAX INT_MIN := ^int(^uint(0)  1) INT_MAX := int(^uint(0)  1) 5. reflect.TypeOf().Kind() reflect.TypeOf().Kind() 可以知道某个变量的类型\n\tstr2 := \"Go语言\" \tfmt.Println(reflect.TypeOf(str2).Kind()) // string \tfmt.Println(reflect.TypeOf(str2[2]).Kind()) // uint8 6. string 因为字符串是以 byte 数组的形式存储的\n7. byte和rune Go语言的字符有以下两种：\n  一种是 uint8 类型，或者叫 byte 型，代表了 ASCII 码的一个字符。\n  另一种是 rune 类型，代表一个 UTF-8 字符，当需要处理中文、日文或者其他复合字符时，则需要用到 rune 类型。rune 类型等价于 int32 类型。\nstr2 := \"Go语言\"  fmt.Printf(\"%d %c\\n\", str2[2], str2[2]) // 232 è fmt.Println(\"len(str2)：\", len(str2)) // len(str2)： 8  // 正确处理中文 runeArr := []rune(str2) fmt.Println(reflect.TypeOf(runeArr[2]).Kind()) // int32 fmt.Println(runeArr[2], string(runeArr[2])) // 35821 语 fmt.Println(\"len(runeArr)：\", len(runeArr)) // len(runeArr)： 4   8. 数组和切片 [5]int // 是数组 []int // 是切片 // 声明数组 var arr [5]int // 一维 var arr2 [5][5]int // 二维  // 声明时初始化数组 var arr = [5]int{1, 2, 3, 4, 5} // 或 arr := [5]int{1, 2, 3, 4, 5}  // 修改数组 arr := [5]int{1, 2, 3, 4, 5} for i := 0; i arr); i++ { \tarr[i] += 100 } fmt.Println(arr) // [101 102 103 104 105] 数组的长度不能改变，如果想拼接2个数组，或是获取子数组，需要使用切片。\n切片是数组的抽象。 切片使用数组作为底层结构。切片包含三个组件：容量，长度和指向底层数组的指针，切片可以随时进行扩展\n// 声明切片 slice1 := make([]float32, 0) // 长度为0的切片 slice2 := make([]float32, 3, 5) // [0 0 0] 长度为3容量为5的切片 fmt.Println(len(slice2), cap(slice2)) // 3 5 // 切片的长度就是它所包含的元素个数。 // 切片的容量是从它的第一个元素开始数，到其底层数组元素末尾的个数。  // 添加元素，切片容量可以根据需要自动扩展 slice2 = append(slice2, 1, 2, 3, 4) // [0, 0, 0, 1, 2, 3, 4] fmt.Println(len(slice2), cap(slice2)) // 7 12 // 当原切片长度小于1024时，新切片的容量会直接翻倍。而当原切片的容量大于等于1024时，会反复地增加25%，直到新容量超过所需要的容量  // 子切片 [start, end) sub1 := slice2[3:] // [1 2 3 4] sub2 := slice2[:3] // [0 0 0] sub3 := slice2[1:4] // [0 0 1]  // 合并切片 combined := append(sub1, sub2...) // [1, 2, 3, 4, 0, 0, 0] // sub2... 是切片解构的写法，将切片解构为 N 个独立的元素 // 从切片中删除元素 func SliceDelete() {  // 初始化一个新的切片 seq  seq := []string{\"a\", \"b\", \"c\", \"d\", \"e\", \"f\", \"g\"}   // 指定删除位置  index := 3   // 输出删除位置之前和之后的元素  fmt.Println(seq[:index], seq[index+1:])  // seq[index+1:]... 表示将后段的整个添加到前段中  // 将删除前后的元素连接起来  seq = append(seq[:index], seq[index+1:]...)  // 输出链接后的切片  fmt.Println(seq) } 9. Map 类似 Python的字典 (dict)\n// 仅声明 m1 := make(map[string]int) // 声明时初始化 m2 := map[string]string{ \t\"Sam\": \"Male\", \t\"Alice\": \"Female\", } // 赋值/修改 m1[\"Tom\"] = 18 func twoSum(nums []int, target int) []int {  nmap := map[int]int{}\t// 声明  for i, x := range nums {  if p, ok := nmap[target-x]; ok {\t// 查找  return []int{p, i}  }  nmap[x] = i\t// 插入  }  return nil } 10. type 和常量 type Gender int8 const ( \tMALE Gender = 1 \tFEMALE Gender = 2 ) // 使用了type 关键字定义了一个新的类型 Gender // 使用 const 定义了 MALE 和 FEMALE 2 个常量 11. switch Go 语言的 switch 不需要 break，匹配到某个 case，执行完该 case 定义的行为后，默认不会继续往下执行。如果需要继续往下执行，需要使用 fallthrough\n12. for 遍历切片和 map nums := []int{10, 20, 30, 40} for i, num := range nums { \tfmt.Println(i, num) } // 0 10 // 1 20 // 2 30 // 3 40  m2 := map[string]string{ \t\"Sam\": \"Male\", \t\"Alice\": \"Female\", }  for key, value := range m2 { \tfmt.Println(key, value) } // Sam Male // Alice Female 13. 函数 13.1 返回值命名 func add(num1 int, num2 int) (ans int) { \tans = num1 + num2 \treturn } 13.2 错误处理 (error handling) import ( \t\"fmt\" \t\"os\" )  func main() { \t_, err := os.Open(\"filename.txt\") \tif err != nil { \tfmt.Println(err) \t} }  // open filename.txt: no such file or directory 可以通过 errorw.New 返回自定义的错误\nimport ( \t\"errors\" \t\"fmt\" )  func hello(name string) error { \tif len(name) == 0 { \treturn errors.New(\"error: name is null\") \t} \tfmt.Println(\"Hello,\", name) \treturn nil }  func main() { \tif err := hello(\"\"); err != nil { \tfmt.Println(err) \t} } // error: name is null 能出现一些不可预知的错误，例如数组越界，这种错误可能会导致程序非正常退出，在 Go 语言中称之为 panic\nfunc get(index int) int { \tarr := [3]int{2, 3, 4} \treturn arr[index] }  func main() { \tfmt.Println(get(5)) \tfmt.Println(\"finished\") } $ go run . panic: runtime error: index out of range [5] with length 3 goroutine 1 [running]: exit status 2 在 Python、Java 等语言中有 try...catch 机制，在 try 中捕获各种类型的异常，在 catch 中定义异常处理的行为。Go 语言也提供了类似的机制 defer 和 recover。\nfunc get(index int) (ret int) { \tdefer func() { \tif r := recover(); r != nil { \tfmt.Println(\"Some error happened!\", r) \tret = -1 \t} \t}() \tarr := [3]int{2, 3, 4} \treturn arr[index] }  func main() { \tfmt.Println(get(5)) \tfmt.Println(\"finished\") } $ go run .Some error happened! runtime error: index out of range [5] with length 3 -1 finished  在 get 函数中，使用 defer 定义了异常处理的函数，在协程退出前，会执行完 defer 挂载的任务。因此如果触发了 panic，控制权就交给了 defer。 在 defer 的处理逻辑中，使用 recover，使程序恢复正常，并且将返回值设置为 -1，在这里也可以不处理返回值，如果不处理返回值，返回值将被置为默认值 0。  14. 结构体，方法和接口 14.1 结构体(struct) 和方法(methods) 结构体类似于其他语言中的 class，可以在结构体中定义多个字段，为结构体实现方法，实例化等\ntype Student struct { \tname string \tage int }  func (stu *Student) hello(person string) string { \treturn fmt.Sprintf(\"hello %s, I am %s\", person, stu.name) }  func main() { \tstu := \u0026Student{ \tname: \"Tom\", \t} \tmsg := stu.hello(\"Jack\") \tfmt.Println(msg) // hello Jack, I am Tom }  使用 Student{field: value, ...}的形式创建 Student 的实例，字段不需要每个都赋值，没有显性赋值的变量将被赋予默认值，例如 age 将被赋予默认值 0。 实现方法与实现函数的区别在于，func 和函数名hello 之间，加上该方法对应的实例名 stu 及其类型 *Student，可以通过实例名访问该实例的字段name和其他方法了。 调用方法通过 实例名.方法名(参数) 的方式。  // 使用 new 实例化 func main() { \tstu2 := new(Student) \tfmt.Println(stu2.hello(\"Alice\")) // hello Alice, I am , name 被赋予默认值\"\" } 14.2 接口(interfaces) 一般而言，接口定义了一组方法的集合，接口不能被实例化，一个类型可以实现多个接口。\n举一个简单的例子，定义一个接口 Person和对应的方法 getName() 和 getAge()：\ntype Person interface { \tgetName() string }  type Student struct { \tname string \tage int }  func (stu *Student) getName() string { \treturn stu.name }  type Worker struct { \tname string \tgender string }  func (w *Worker) getName() string { \treturn w.name }  func main() { \tvar p Person = \u0026Student{ \tname: \"Tom\", \tage: 18, \t} \tfmt.Println(p.getName()) // Tom }  Go 语言中，并不需要显式地声明实现了哪一个接口，只需要直接实现该接口对应的方法即可。 实例化 Student后，强制类型转换为接口类型 Person。  在上面的例子中，我们在 main 函数中尝试将 Student 实例类型转换为 Person，如果 Student 没有完全实现 Person 的方法，比如我们将 (*Student).getName() 删掉，编译时会出现如下报错信息。\n但是删除 (*Worker).getName() 程序并不会报错，因为我们并没有在 main 函数中使用。这种情况下我们如何确保某个类型实现了某个接口的所有方法呢？一般可以使用下面的方法进行检测，如果实现不完整，编译期将会报错。\nvar _ Person = (*Student)(nil) var _ Person = (*Worker)(nil)  将空值 nil 转换为 *Student 类型，再转换为 Person 接口，如果转换失败，说明 Student 并没有实现 Person 接口的所有方法。 Worker 同上。  实例可以强制类型转换为接口，接口也可以强制类型转换为实例。\nfunc main() { \tvar p Person = \u0026Student{ \tname: \"Tom\", \tage: 18, \t}  \tstu := p.(*Student) // 接口转为实例 \tfmt.Println(stu.getAge()) } 14.3 空接口 如果定义了一个没有任何方法的空接口，那么这个接口可以表示任意类型。例如\nfunc main() { \tm := make(map[string]interface{}) \tm[\"name\"] = \"Tom\" \tm[\"age\"] = 18 \tm[\"scores\"] = [3]int{98, 99, 85} \tfmt.Println(m) // map[age:18 name:Tom scores:[98 99 85]] } 15. 并发编程(goroutine) Go 语言提供了 sync 和 channel 两种方式支持协程(goroutine)的并发。\n15.1 sync 例如我们希望并发下载 N 个资源，多个并发协程之间不需要通信，那么就可以使用 sync.WaitGroup，等待所有并发协程执行结束。\nimport ( \t\"fmt\" \t\"sync\" \t\"time\" )  var wg sync.WaitGroup  func download(url string) { \tfmt.Println(\"start to download\", url) \ttime.Sleep(time.Second) // 模拟耗时操作 \twg.Done() }  func main() { \tfor i := 0; i 3; i++ { \twg.Add(1) \tgo download(\"a.com/\" + string(i+'0')) \t} \twg.Wait() \tfmt.Println(\"Done!\") }  wg.Add(1)：为 wg 添加一个计数，wg.Done()，减去一个计数。 go download()：启动新的协程并发执行 download 函数。 wg.Wait()：等待所有的协程执行结束。  $ time go run . start to download a.com/2 start to download a.com/0 start to download a.com/1 Done!  real 0m1.563s 可以看到串行需要 3s 的下载操作，并发后，只需要 1s\n15.3 channel var ch = make(chan string, 10) // 创建大小为 10 的缓冲信道  func download(url string) { \tfmt.Println(\"start to download\", url) \ttime.Sleep(time.Second) \tch  url // 将 url 发送给信道 }  func main() { \tfor i := 0; i 3; i++ { \tgo download(\"a.com/\" + string(i+'0')) \t} \tfor i := 0; i 3; i++ { \tmsg := ch // 等待信道返回消息。 \tfmt.Println(\"finish\", msg) \t} \tfmt.Println(\"Done!\") } 使用 channel 信道，可以在协程之间传递消息。阻塞等待并发协程返回消息\n$ time go run . start to download a.com/2 start to download a.com/0 start to download a.com/1 finish a.com/2 finish a.com/1 finish a.com/0 Done!  real 0m1.528s 16. 单元测试(unit test) 假设我们希望测试 package main 下 calc.go 中的函数，要只需要新建 calc_test.go 文件，在calc_test.go中新建测试用例即可\n// calc.go package main  func add(num1 int, num2 int) int { \treturn num1 + num2 } // calc_test.go package main  import \"testing\"  func TestAdd(t *testing.T) { \tif ans := add(1, 2); ans != 3 { \tt.Error(\"add(1, 2) should be equal to 3\") \t} } 运行 go test，将自动运行当前 package 下的所有测试用例，如果需要查看详细的信息，可以添加-v参数。\n$ go test -v === RUN TestAdd --- PASS: TestAdd (0.00s) PASS ok example 0.040s 17. 包(Package)和模块(Modules) 17.1 Package 一般来说，一个文件夹可以作为 package，同一个 package 内部变量、类型、方法等定义可以相互看到。\n比如我们新建一个文件 calc.go， main.go 平级，分别定义 add 和 main 方法。\n// calc.go package main  func add(num1 int, num2 int) int { \treturn num1 + num2 } // main.go package main  import \"fmt\"  func main() { \tfmt.Println(add(3, 5)) // 8 } 运行 go run main.go，会报错，add 未定义：\n./main.go:6:14: undefined: add 因为 go run main.go 仅编译 main.go 一个文件，所以命令需要换成\n$ go run main.go calc.go 8 或\n$ go run . 8 Go 语言也有 Public 和 Private 的概念，粒度是包。如果类型/接口/方法/函数/字段的首字母大写，则是 Public 的，对其他 package 可见，如果首字母小写，则是 Private 的，对其他 package 不可见。\n17.2 Modules Go Modules 是 Go 1.11 版本之后引入的，Go 1.11 之前使用 $GOPATH 机制。Go Modules 可以算作是较为完善的包管理工具。同时支持代理，国内也能享受高速的第三方包镜像服务。接下来简单介绍 go mod 的使用。Go Modules 在 1.13 版本仍是可选使用的，环境变量 GO111MODULE 的值默认为 AUTO，强制使用 Go Modules 进行依赖管理，可以将 GO111MODULE 设置为 ON。\n在一个空文件夹下，初始化一个 Module\n$ go mod init example go: creating new go.mod: module example 此时，在当前文件夹下生成了go.mod，这个文件记录当前模块的模块名以及所有依赖包的版本。\n接着，我们在当前目录下新建文件 main.go，添加如下代码：\npackage main  import ( \t\"fmt\"  \t\"rsc.io/quote\" )  func main() { \tfmt.Println(quote.Hello()) // Ahoy, world! } 运行 go run .，将会自动触发第三方包 rsc.io/quote的下载，具体的版本信息也记录在了go.mod中：\nmodule example  go 1.13  require rsc.io/quote v3.1.0+incompatible 我们在当前目录，添加一个子 package calc，代码目录如下：\ndemo/  |--calc/  |--calc.go  |--main.go // calc.go package calc  func Add(num1 int, num2 int) int { \treturn num1 + num2 } 在 package main 中如何使用 package cal 中的 Add 函数呢？import 模块名/子目录名 即可，修改后的 main 函数如下：\npackage main  import ( \t\"fmt\" \t\"example/calc\"  \t\"rsc.io/quote\" )  func main() { \tfmt.Println(quote.Hello()) \tfmt.Println(calc.Add(10, 3)) } $ go run . Ahoy, world! 13 #  conda initialize  # !! Contents within this block are managed by 'conda init' !! __conda_setup=\"$('/Users/hzpan/anaconda3/bin/conda' 'shell.bash' 'hook' 2 /dev/null)\" if [ $? -eq 0 ]; then eval \"$__conda_setup\" else if [ -f \"/Users/hzpan/anaconda3/etc/profile.d/conda.sh\" ]; then . \"/Users/hzpan/anaconda3/etc/profile.d/conda.sh\" else export PATH=\"/Users/hzpan/anaconda3/bin:$PATH\" fi fi unset __conda_setup /opt/anaconda3/bin/conda # 18. rand func (r *Rand) Int() int func (r *Rand) Int31() int32 func (r *Rand) Int63() int64 func (r *Rand) Uint32() uint32 func (r *Rand) Float32() float32\t// 返回一个取值范围在[0.0, 1.0)的伪随机float32值 func (r *Rand) Float64() float64\t// 返回一个取值范围在[0.0, 1.0)的伪随机float64值 19. sync.Map 什么是 sync.Map？ Go 语言原生 map 并不是线程安全的，对它进行并发读写操作的时候，需要加锁。而 sync.map 则是一种并发安全的 map，在 Go 1.9 引入。\n sync.map 是线程安全的，读取，插入，删除也都保持着常数级的时间复杂度。 sync.map 的零值是有效的，并且零值是一个空的 map。在第一次使用之后，不允许被拷贝。\n 什么是 CAS 机制？ CAS，是Compare and Swap的简称，在这个机制中有三个核心的参数：\n 主内存中存放的共享变量的值：V（一般情况下这个V是内存的地址值，通过这个地址可以获得内存中的值） 工作内存中共享变量的副本值，也叫预期值：A 需要将共享变量更新到的最新值：B  如上图中，主存中保存 V 值，线程中要使用 V 值要先从主存中读取 V 值到线程的工作内存A中，然后计算后变成 B 值，最后再把 B 值写回到内存 V 值中。多个线程共用 V 值都是如此操作。 CAS 的核心是在将 B 值写入到 V 之前要比较 A 值和 V 值是否相同，如果不相同证明此时 V 值已经被其他线程改变，重新将 V 值赋给 A，并重新计算得到 B，如果相同，则将 B 值赋给 V。\n值得注意的是 CAS 机制中的这步步骤是原子性的（从指令层面提供的原子操作），所以 CAS 机制可以解决多线程并发编程对共享变量读写的原子性问题。\nCAS机制优缺点 缺点 1. ABA 问题 ABA 问题：CAS 在操作的时候会检查变量的值是否被更改过，如果没有则更新值，但是带来一个问题，最开始的值是 A，接着变成 B，最后又变成了 A。经过检查这个值确实没有修改过，因为最后的值还是 A，但是实际上这个值确实已经被修改过了。为了解决这个问题，在每次进行操作的时候加上一个版本号，每次操作的就是两个值，一个版本号和某个值，A——B——A 问题就变成了 1A——2B——3A。\n2. 可能会消耗较高的 CPU 看起来 CAS 比锁的效率高，从阻塞机制变成了非阻塞机制，减少了线程之间等待的时间。每个方法不能绝对的比另一个好，在线程之间竞争程度大的时候，如果使用 CAS，每次都有很多的线程在竞争，也就是说 CAS 机制不能更新成功。这种情况下 CAS 机制会一直重试，这样就会比较耗费 CPU。因此可以看出，如果线程之间竞争程度小，使用 CAS 是一个很好的选择；但是如果竞争很大，使用锁可能是个更好的选择。在并发量非常高的环境中，如果仍然想通过原子类来更新的话，可以使用 AtomicLong 的替代类：LongAdder。\n3. 不能保证代码块的原子性 Java 中的 CAS 机制只能保证共享变量操作的原子性，而不能保证代码块的原子性。\n优点  可以保证变量操作的原子性； 并发量不是很高的情况下，使用 CAS 机制比使用锁机制效率更高； 在线程对共享资源占用时间较短的情况下，使用 CAS 机制效率也会较高。  源码分析 map 的数据结构：\ntype Map struct {  mu Mutex  read atomic.Value // readOnly  dirty map[interface{}]*entry  misses int } 互斥量 mu 保护 read 和 dirty。\nread 是 atomic.Value 类型，可以并发地读。但如果需要更新 read，则需要加锁保护。对于 read 中存储的 entry 字段，可能会被并发地 CAS 更新。但是如果要更新一个之前已被删除的 entry，则需要先将其状态从 expunged 改为 nil，再拷贝到 dirty 中，然后再更新。\ndirty 是一个非线程安全的原始 map。包含新写入的 key，并且包含 read 中的所有未被删除的 key。这样，可以快速地将 dirty 提升为 read 对外提供服务。如果 dirty 为 nil，那么下一次写入时，会新建一个新的 dirty，这个初始的 dirty 是 read 的一个拷贝，但除掉了其中已被删除的 key。\n每当从 read 中读取失败，都会将 misses 的计数值加 1，当加到一定阈值以后，需要将 dirty 提升为 read，以期减少 miss 的情形。\n真正存储 key/value 的是 read 和 dirty 字段。read 使用 atomic.Value，这是 lock-free 的基础，保证 load/store 的原子性。dirty 则直接用了一个原始的 map，对于它的 load/store 操作需要加锁。\n常见用法 1. 排序 排序整数、浮点数和字符串切片 //sort.Ints //sort.Floats //sort.Strings s := []int{4, 2, 3, 1} sort.Ints(s) fmt.Println(s) // 输出[1 2 3 4] 使用自定义比较器排序 family := []struct {  Name string  Age int }{  {\"Alice\", 23},  {\"David\", 2},  {\"Eve\", 2},  {\"Bob\", 25}, }  // 用 age 排序，年龄相等的元素保持原始顺序 sort.SliceStable(family, func(i, j int) bool {  return family[i].Age family[j].Age }) fmt.Println(family) // [{David 2} {Eve 2} {Alice 23} {Bob 25}] 2. SearchInts // search 源码 func SearchInts(a []int, x int) int { \treturn Search(len(a), func(i int) bool { return a[i] = x }) }  func Search(n int, f func(int) bool) int { \t// Define f(-1) == false and f(n) == true. \t// Invariant: f(i-1) == false, f(j) == true. \ti, j := 0, n \tfor i j { \th := int(uint(i+j)  1) // avoid overflow when computing h \t// i ≤ h \tif !f(h) { \ti = h + 1 // preserves f(i-1) == false \t} else { \tj = h // preserves f(j) == true \t} \t} \t// i == j, f(i-1) == false, and f(j) (= f(i)) == true = answer is i. \treturn i } 排序任意数据结构  使用sort.Sort或者sort.Stable函数。 他们可以排序实现了sort.Interface接口的任意类型  一个内置的排序算法需要知道三个东西：序列的长度，表示两个元素比较的结果，一种交换两个元素的方式；这就是sort.Interface的三个方法：\ntype Interface interface {  Len() int  Less(i, j int) bool // i, j 是元素的索引  Swap(i, j int) } 还是以上面的结构体切片为例子，我们为切片类型自定义一个类型名，然后在自定义的类型上实现 srot.Interface 接口\ntype Person struct {  Name string  Age int }  // ByAge 通过对age排序实现了sort.Interface接口 type ByAge []Person  func (a ByAge) Len() int { return len(a) } func (a ByAge) Less(i, j int) bool { return a[i].Age a[j].Age } func (a ByAge) Swap(i, j int) { a[i], a[j] = a[j], a[i] }  func main() {  family := []Person{  {\"David\", 2},  {\"Alice\", 23},  {\"Eve\", 2},  {\"Bob\", 25},  }  sort.Sort(ByAge(family))  fmt.Println(family) // [{David, 2} {Eve 2} {Alice 23} {Bob 25}] } 实现了sort.Interface的具体类型不一定是切片类型；下面的customSort是一个结构体类型\ntype customSort struct {  p []*Person  less func(x, y *Person) bool }  func (x customSort) Len() int {len(x.p)} func (x customSort) Less(i, j int) bool { return x.less(x.p[i], x.p[j]) } func (x customSort) Swap(i, j int) { x.p[i], x.p[j] = x.p[j], x.p[i] } 让我们定义一个根据多字段排序的函数，它主要的排序键是Age，Age 相同了再按 Name 进行倒序排序。下面是该排序的调用，其中这个排序使用了匿名排序函数：\nsort.Sort(customSort{persons, func(x, y *Person) bool {  if x.Age != y.Age {  return x.Age y.Age  }  if x.Name != y.Name {  return x.Name  y.Name  }  return false }}) 3. 优先队列实现 630. 课程表 III\ntype Heap struct {  sort.IntSlice }  func (h Heap) Less(i, j int) bool {  return h.IntSlice[i]  h.IntSlice[j] }  func (h *Heap) Push(x interface{}) {  h.IntSlice = append(h.IntSlice, x.(int)) }  func (h *Heap) Pop() interface{} {  a := h.IntSlice  x := a[len(a)-1]  h.IntSlice = a[:len(a)-1]  return x }  //courses = [[100, 200], [200, 1300], [1000, 1250], [2000, 3200]] func main() {  h := \u0026Heap{}  // heap.Push(h, t)  // heap.Fix(h, 0) } ",
  "wordCount" : "2238",
  "inLanguage": "en",
  "datePublished": "2022-01-17T10:04:52+08:00",
  "dateModified": "2022-01-17T10:04:52+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://perhapzz.github.io/posts/golang/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "perhapzz",
    "logo": {
      "@type": "ImageObject",
      "url": "https://perhapzz.github.io/favicon/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://perhapzz.github.io" accesskey="h" title="perhapzz (Alt + H)">perhapzz</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://perhapzz.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://perhapzz.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://perhapzz.github.io">Home</a>&nbsp;»&nbsp;<a href="https://perhapzz.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      golang学习笔记
    </h1>
    <div class="post-description">
      Git学习笔记
    </div>
    <div class="post-meta"><span title='2022-01-17 10:04:52 +0800 CST'>January 17, 2022</span>

</div>
  </header> 
  <div class="post-content"><h2 id="基础知识">基础知识<a hidden class="anchor" aria-hidden="true" href="#基础知识">#</a></h2>
<h3 id="1-变量定义">1. 变量定义<a hidden class="anchor" aria-hidden="true" href="#1-变量定义">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// 如果没有赋值，默认为0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">1</span> <span style="color:#75715e">// 声明时赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> = <span style="color:#ae81ff">1</span> <span style="color:#75715e">// 声明时赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h3 id="2-new-和-make">2. new 和 make<a hidden class="anchor" aria-hidden="true" href="#2-new-和-make">#</a></h3>
<p>new 的作用是初始化一个指向类型的指针(*T)。使用new函数来分配空间。传递给new函数的是一个类型，不是一个值。返回值是 指向这个新分配的零值的指针</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Definition for singly-linked list.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * type ListNode struct {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *     Val int
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *     Next *ListNode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法一：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">ListNode</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">val</span> = <span style="color:#a6e22e">val</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Next</span> =
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法二：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ListNode</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">val</span>, <span style="color:#a6e22e">next</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>make 的作用是为 slice，map 或 chan 初始化并返回引用(T)</p>
<h3 id="3-变量类型">3. 变量类型<a hidden class="anchor" aria-hidden="true" href="#3-变量类型">#</a></h3>
<p>空值：nil</p>
<p>整型类型： int(取决于操作系统), int8, int16, int32, int64, uint8, uint16, …</p>
<p>浮点数类型：float32, float64</p>
<p>字节类型：byte (等价于uint8)</p>
<p>字符串类型：string</p>
<p>布尔值类型：boolean，(true 或 false)</p>
<h3 id="4-int_min-和-int_max">4. INT_MIN 和 INT_MAX<a hidden class="anchor" aria-hidden="true" href="#4-int_min-和-int_max">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">INT_MIN</span> <span style="color:#f92672">:=</span> ^int(^uint(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">INT_MAX</span> <span style="color:#f92672">:=</span> int(^uint(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><h3 id="5-reflecttypeofkind">5. reflect.TypeOf().Kind()<a hidden class="anchor" aria-hidden="true" href="#5-reflecttypeofkind">#</a></h3>
<p>reflect.TypeOf().Kind() 可以知道某个变量的类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#a6e22e">str2</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;Go语言&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">str2</span>).<span style="color:#a6e22e">Kind</span>())    <span style="color:#75715e">// string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">str2</span>[<span style="color:#ae81ff">2</span>]).<span style="color:#a6e22e">Kind</span>()) <span style="color:#75715e">// uint8
</span></span></span></code></pre></div><h3 id="6-string">6. string<a hidden class="anchor" aria-hidden="true" href="#6-string">#</a></h3>
<p>因为字符串是以 byte 数组的形式存储的</p>
<h3 id="7-byte和rune">7. byte和rune<a hidden class="anchor" aria-hidden="true" href="#7-byte和rune">#</a></h3>
<p>Go语言的字符有以下两种：</p>
<ul>
<li>
<p>一种是 uint8 类型，或者叫 byte 型，代表了 ASCII 码的一个字符。</p>
</li>
<li>
<p>另一种是 rune 类型，代表一个 UTF-8 字符，当需要处理中文、日文或者其他复合字符时，则需要用到 rune 类型。rune 类型等价于 int32 类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">str2</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;Go语言&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d %c\n&#34;</span>, <span style="color:#a6e22e">str2</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">str2</span>[<span style="color:#ae81ff">2</span>])     	 <span style="color:#75715e">// 232 è
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;len(str2)：&#34;</span>, len(<span style="color:#a6e22e">str2</span>))       		<span style="color:#75715e">// len(str2)： 8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 正确处理中文
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">runeArr</span> <span style="color:#f92672">:=</span> []rune(<span style="color:#a6e22e">str2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">runeArr</span>[<span style="color:#ae81ff">2</span>]).<span style="color:#a6e22e">Kind</span>()) <span style="color:#75715e">// int32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">runeArr</span>[<span style="color:#ae81ff">2</span>], string(<span style="color:#a6e22e">runeArr</span>[<span style="color:#ae81ff">2</span>]))    <span style="color:#75715e">// 35821 语
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;len(runeArr)：&#34;</span>, len(<span style="color:#a6e22e">runeArr</span>))    <span style="color:#75715e">// len(runeArr)： 4
</span></span></span></code></pre></div></li>
</ul>
<h3 id="8-数组和切片">8. 数组和切片<a hidden class="anchor" aria-hidden="true" href="#8-数组和切片">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>[<span style="color:#ae81ff">5</span>]<span style="color:#66d9ef">int</span> <span style="color:#75715e">// 是数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[]<span style="color:#66d9ef">int</span> <span style="color:#75715e">// 是切片
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 声明数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr</span> [<span style="color:#ae81ff">5</span>]<span style="color:#66d9ef">int</span>     <span style="color:#75715e">// 一维
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr2</span> [<span style="color:#ae81ff">5</span>][<span style="color:#ae81ff">5</span>]<span style="color:#66d9ef">int</span> <span style="color:#75715e">// 二维 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 声明时初始化数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr</span> = [<span style="color:#ae81ff">5</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 或 arr := [5]int{1, 2, 3, 4, 5}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 修改数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">arr</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">5</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">arr</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">arr</span>)  <span style="color:#75715e">// [101 102 103 104 105]
</span></span></span></code></pre></div><p>数组的长度不能改变，如果想拼接2个数组，或是获取子数组，需要使用切片。</p>
<p>切片是数组的抽象。 切片使用数组作为底层结构。切片包含三个组件：容量，长度和指向底层数组的指针，切片可以随时进行扩展</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 声明切片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">slice1</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float32</span>, <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// 长度为0的切片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">slice2</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">float32</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>) <span style="color:#75715e">// [0 0 0] 长度为3容量为5的切片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(len(<span style="color:#a6e22e">slice2</span>), cap(<span style="color:#a6e22e">slice2</span>)) <span style="color:#75715e">// 3 5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 切片的长度就是它所包含的元素个数。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 切片的容量是从它的第一个元素开始数，到其底层数组元素末尾的个数。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 添加元素，切片容量可以根据需要自动扩展
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">slice2</span> = append(<span style="color:#a6e22e">slice2</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>) <span style="color:#75715e">// [0, 0, 0, 1, 2, 3, 4]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(len(<span style="color:#a6e22e">slice2</span>), cap(<span style="color:#a6e22e">slice2</span>)) <span style="color:#75715e">// 7 12
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 当原切片长度小于1024时，新切片的容量会直接翻倍。而当原切片的容量大于等于1024时，会反复地增加25%，直到新容量超过所需要的容量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 子切片 [start, end)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sub1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slice2</span>[<span style="color:#ae81ff">3</span>:] <span style="color:#75715e">// [1 2 3 4]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sub2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slice2</span>[:<span style="color:#ae81ff">3</span>] <span style="color:#75715e">// [0 0 0]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sub3</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slice2</span>[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">4</span>] <span style="color:#75715e">// [0 0 1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 合并切片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">combined</span> <span style="color:#f92672">:=</span> append(<span style="color:#a6e22e">sub1</span>, <span style="color:#a6e22e">sub2</span><span style="color:#f92672">...</span>) <span style="color:#75715e">// [1, 2, 3, 4, 0, 0, 0]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// sub2... 是切片解构的写法，将切片解构为 N 个独立的元素
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 从切片中删除元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SliceDelete</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 初始化一个新的切片 seq
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">seq</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#e6db74">&#34;b&#34;</span>, <span style="color:#e6db74">&#34;c&#34;</span>, <span style="color:#e6db74">&#34;d&#34;</span>, <span style="color:#e6db74">&#34;e&#34;</span>, <span style="color:#e6db74">&#34;f&#34;</span>, <span style="color:#e6db74">&#34;g&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 指定删除位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 输出删除位置之前和之后的元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">seq</span>[:<span style="color:#a6e22e">index</span>], <span style="color:#a6e22e">seq</span>[<span style="color:#a6e22e">index</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:])
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// seq[index+1:]... 表示将后段的整个添加到前段中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 将删除前后的元素连接起来
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">seq</span> = append(<span style="color:#a6e22e">seq</span>[:<span style="color:#a6e22e">index</span>], <span style="color:#a6e22e">seq</span>[<span style="color:#a6e22e">index</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 输出链接后的切片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">seq</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="9-map">9. Map<a hidden class="anchor" aria-hidden="true" href="#9-map">#</a></h3>
<p>类似 Python的字典 (dict)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 仅声明
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">m1</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 声明时初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">m2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;Sam&#34;</span>: <span style="color:#e6db74">&#34;Male&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;Alice&#34;</span>: <span style="color:#e6db74">&#34;Female&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 赋值/修改
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">m1</span>[<span style="color:#e6db74">&#34;Tom&#34;</span>] = <span style="color:#ae81ff">18</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">twoSum</span>(<span style="color:#a6e22e">nums</span> []<span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">target</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nmap</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>{}	<span style="color:#75715e">// 声明
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">nums</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nmap</span>[<span style="color:#a6e22e">target</span><span style="color:#f92672">-</span><span style="color:#a6e22e">x</span>]; <span style="color:#a6e22e">ok</span> {	<span style="color:#75715e">// 查找
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">int</span>{<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">i</span>}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">nmap</span>[<span style="color:#a6e22e">x</span>] = <span style="color:#a6e22e">i</span>	<span style="color:#75715e">// 插入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="10-type-和常量">10. type 和常量<a hidden class="anchor" aria-hidden="true" href="#10-type-和常量">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Gender</span> <span style="color:#66d9ef">int8</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">MALE</span>   <span style="color:#a6e22e">Gender</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">FEMALE</span> <span style="color:#a6e22e">Gender</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 使用了type 关键字定义了一个新的类型 Gender
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 使用 const 定义了 MALE 和 FEMALE 2 个常量
</span></span></span></code></pre></div><h3 id="11-switch">11. switch<a hidden class="anchor" aria-hidden="true" href="#11-switch">#</a></h3>
<p>Go 语言的 switch 不需要 break，匹配到某个 case，执行完该 case 定义的行为后，默认不会继续往下执行。如果需要继续往下执行，需要使用 fallthrough</p>
<h3 id="12-for-遍历切片和-map">12. for 遍历切片和 map<a hidden class="anchor" aria-hidden="true" href="#12-for-遍历切片和-map">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">40</span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">num</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">nums</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">num</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 0 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 1 20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 2 30
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 3 40
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m2</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;Sam&#34;</span>:   <span style="color:#e6db74">&#34;Male&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;Alice&#34;</span>: <span style="color:#e6db74">&#34;Female&#34;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">m2</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Sam Male
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Alice Female
</span></span></span></code></pre></div><h3 id="13-函数">13. 函数<a hidden class="anchor" aria-hidden="true" href="#13-函数">#</a></h3>
<h4 id="131-返回值命名">13.1 返回值命名<a hidden class="anchor" aria-hidden="true" href="#131-返回值命名">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num1</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">num2</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">ans</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ans</span> = <span style="color:#a6e22e">num1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">num2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="132-错误处理-error-handling">13.2 错误处理 (error handling)<a hidden class="anchor" aria-hidden="true" href="#132-错误处理-error-handling">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;filename.txt&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// open filename.txt: no such file or directory
</span></span></span></code></pre></div><p>可以通过 <code>errorw.New</code> 返回自定义的错误</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hello</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;error: name is null&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hello,&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hello</span>(<span style="color:#e6db74">&#34;&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// error: name is null
</span></span></span></code></pre></div><p>能出现一些不可预知的错误，例如数组越界，这种错误可能会导致程序非正常退出，在 Go 语言中称之为 panic</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">arr</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">index</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">get</span>(<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;finished&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> .
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">panic</span>: <span style="color:#a6e22e">runtime</span> <span style="color:#66d9ef">error</span>: <span style="color:#a6e22e">index</span> <span style="color:#a6e22e">out</span> <span style="color:#a6e22e">of</span> <span style="color:#66d9ef">range</span> [<span style="color:#ae81ff">5</span>] <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">length</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> [<span style="color:#a6e22e">running</span>]:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exit</span> <span style="color:#a6e22e">status</span> <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><p>在 Python、Java 等语言中有 <code>try...catch</code> 机制，在 <code>try</code> 中捕获各种类型的异常，在 <code>catch</code> 中定义异常处理的行为。Go 语言也提供了类似的机制 <code>defer</code> 和 <code>recover</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">ret</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Some error happened!&#34;</span>, <span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ret</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">arr</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">index</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">get</span>(<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;finished&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> .<span style="color:#a6e22e">Some</span> <span style="color:#66d9ef">error</span> <span style="color:#a6e22e">happened</span>! 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">runtime</span> <span style="color:#66d9ef">error</span>: <span style="color:#a6e22e">index</span> <span style="color:#a6e22e">out</span> <span style="color:#a6e22e">of</span> <span style="color:#66d9ef">range</span> [<span style="color:#ae81ff">5</span>] <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">length</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">finished</span>
</span></span></code></pre></div><ul>
<li>在 get 函数中，使用 defer 定义了异常处理的函数，在协程退出前，会执行完 defer 挂载的任务。因此如果触发了 panic，控制权就交给了 defer。</li>
<li>在 defer 的处理逻辑中，使用 recover，使程序恢复正常，并且将返回值设置为 -1，在这里也可以不处理返回值，如果不处理返回值，返回值将被置为默认值 0。</li>
</ul>
<h3 id="14-结构体方法和接口">14. 结构体，方法和接口<a hidden class="anchor" aria-hidden="true" href="#14-结构体方法和接口">#</a></h3>
<h4 id="141-结构体struct-和方法methods">14.1 结构体(struct) 和方法(methods)<a hidden class="anchor" aria-hidden="true" href="#141-结构体struct-和方法methods">#</a></h4>
<p>结构体类似于其他语言中的 class，可以在结构体中定义多个字段，为结构体实现方法，实例化等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Student</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">stu</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Student</span>) <span style="color:#a6e22e">hello</span>(<span style="color:#a6e22e">person</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;hello %s, I am %s&#34;</span>, <span style="color:#a6e22e">person</span>, <span style="color:#a6e22e">stu</span>.<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stu</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Student</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">name</span>: <span style="color:#e6db74">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stu</span>.<span style="color:#a6e22e">hello</span>(<span style="color:#e6db74">&#34;Jack&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">msg</span>) <span style="color:#75715e">// hello Jack, I am Tom
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>使用 <code>Student{field: value, ...}</code>的形式创建 Student 的实例，字段不需要每个都赋值，没有显性赋值的变量将被赋予默认值，例如 age 将被赋予默认值 0。</li>
<li>实现方法与实现函数的区别在于，<code>func</code> 和函数名<code>hello</code> 之间，加上该方法对应的实例名 <code>stu</code> 及其类型 <code>*Student</code>，可以通过实例名访问该实例的字段<code>name</code>和其他方法了。</li>
<li>调用方法通过 <code>实例名.方法名(参数)</code> 的方式。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 使用 new 实例化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stu2</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">Student</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">stu2</span>.<span style="color:#a6e22e">hello</span>(<span style="color:#e6db74">&#34;Alice&#34;</span>)) <span style="color:#75715e">// hello Alice, I am  , name 被赋予默认值&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="142-接口interfaces">14.2 接口(interfaces)<a hidden class="anchor" aria-hidden="true" href="#142-接口interfaces">#</a></h4>
<p>一般而言，接口定义了一组<strong>方法的集合</strong>，接口不能被实例化，一个类型可以实现多个接口。</p>
<p>举一个简单的例子，定义一个接口 <code>Person</code>和对应的方法 <code>getName()</code> 和 <code>getAge()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Person</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getName</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Student</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">stu</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Student</span>) <span style="color:#a6e22e">getName</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">stu</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Worker</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span>   <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gender</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Worker</span>) <span style="color:#a6e22e">getName</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Person</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Student</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">name</span>: <span style="color:#e6db74">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">age</span>:  <span style="color:#ae81ff">18</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">getName</span>()) <span style="color:#75715e">// Tom
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>Go 语言中，并不需要显式地声明实现了哪一个接口，只需要直接实现该接口对应的方法即可。</li>
<li>实例化 <code>Student</code>后，强制类型转换为接口类型 Person。</li>
</ul>
<p>在上面的例子中，我们在 main 函数中尝试将 Student 实例类型转换为 Person，如果 Student 没有完全实现 Person 的方法，比如我们将 <code>(*Student).getName()</code> 删掉，编译时会出现如下报错信息。</p>
<p>但是删除 <code>(*Worker).getName()</code> 程序并不会报错，因为我们并没有在 main 函数中使用。这种情况下我们如何确保某个类型实现了某个接口的所有方法呢？一般可以使用下面的方法进行检测，如果实现不完整，编译期将会报错。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">Person</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">Student</span>)(<span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">Person</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">Worker</span>)(<span style="color:#66d9ef">nil</span>)
</span></span></code></pre></div><ul>
<li>将空值 nil 转换为 *Student 类型，再转换为 Person 接口，如果转换失败，说明 Student 并没有实现 Person 接口的所有方法。</li>
<li>Worker 同上。</li>
</ul>
<p>实例可以强制类型转换为接口，接口也可以强制类型转换为实例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Person</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Student</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">name</span>: <span style="color:#e6db74">&#34;Tom&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">age</span>:  <span style="color:#ae81ff">18</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stu</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Student</span>) <span style="color:#75715e">// 接口转为实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">stu</span>.<span style="color:#a6e22e">getAge</span>())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="143-空接口">14.3 空接口<a hidden class="anchor" aria-hidden="true" href="#143-空接口">#</a></h4>
<p>如果定义了一个没有任何方法的空接口，那么这个接口可以表示任意类型。例如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;name&#34;</span>] = <span style="color:#e6db74">&#34;Tom&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;age&#34;</span>] = <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>[<span style="color:#e6db74">&#34;scores&#34;</span>] = [<span style="color:#ae81ff">3</span>]<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">98</span>, <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">85</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">m</span>) <span style="color:#75715e">// map[age:18 name:Tom scores:[98 99 85]]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="15-并发编程goroutine">15. 并发编程(goroutine)<a hidden class="anchor" aria-hidden="true" href="#15-并发编程goroutine">#</a></h3>
<p>Go 语言提供了 sync 和 channel 两种方式支持协程(goroutine)的并发。</p>
<h4 id="151-sync">15.1 sync<a hidden class="anchor" aria-hidden="true" href="#151-sync">#</a></h4>
<p>例如我们希望并发下载 N 个资源，多个并发协程之间不需要通信，那么就可以使用 sync.WaitGroup，等待所有并发协程执行结束。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">download</span>(<span style="color:#a6e22e">url</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start to download&#34;</span>, <span style="color:#a6e22e">url</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>) <span style="color:#75715e">// 模拟耗时操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">download</span>(<span style="color:#e6db74">&#34;a.com/&#34;</span> <span style="color:#f92672">+</span> string(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;0&#39;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>wg.Add(1)：为 wg 添加一个计数，wg.Done()，减去一个计数。</li>
<li>go download()：启动新的协程并发执行 download 函数。</li>
<li>wg.Wait()：等待所有的协程执行结束。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span>  <span style="color:#a6e22e">time</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> .
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">download</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">download</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">download</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Done</span>!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">real</span>    <span style="color:#ae81ff">0</span><span style="color:#a6e22e">m1</span><span style="color:#ae81ff">.563</span><span style="color:#a6e22e">s</span>
</span></span></code></pre></div><p>可以看到串行需要 3s 的下载操作，并发后，只需要 1s</p>
<h4 id="153-channel">15.3 channel<a hidden class="anchor" aria-hidden="true" href="#153-channel">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">10</span>) <span style="color:#75715e">// 创建大小为 10 的缓冲信道
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">download</span>(<span style="color:#a6e22e">url</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start to download&#34;</span>, <span style="color:#a6e22e">url</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">url</span> <span style="color:#75715e">// 将 url 发送给信道
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">download</span>(<span style="color:#e6db74">&#34;a.com/&#34;</span> <span style="color:#f92672">+</span> string(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;0&#39;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span> <span style="color:#75715e">// 等待信道返回消息。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;finish&#34;</span>, <span style="color:#a6e22e">msg</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用 channel 信道，可以在协程之间传递消息。阻塞等待并发协程返回消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">time</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> .
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">download</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">download</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">download</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">finish</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">finish</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">finish</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Done</span>!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">real</span>    <span style="color:#ae81ff">0</span><span style="color:#a6e22e">m1</span><span style="color:#ae81ff">.528</span><span style="color:#a6e22e">s</span>
</span></span></code></pre></div><h3 id="16-单元测试unit-test">16. 单元测试(unit test)<a hidden class="anchor" aria-hidden="true" href="#16-单元测试unit-test">#</a></h3>
<p>假设我们希望测试 package main 下 <code>calc.go</code> 中的函数，要只需要新建 <code>calc_test.go</code> 文件，在<code>calc_test.go</code>中新建测试用例即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// calc.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num1</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">num2</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">num2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// calc_test.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestAdd</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ans</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>); <span style="color:#a6e22e">ans</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;add(1, 2) should be equal to 3&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>运行 <code>go test</code>，将自动运行当前 package 下的所有测试用例，如果需要查看详细的信息，可以添加<code>-v</code>参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">test</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>= <span style="color:#a6e22e">RUN</span>   <span style="color:#a6e22e">TestAdd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> <span style="color:#a6e22e">PASS</span>: <span style="color:#a6e22e">TestAdd</span> (<span style="color:#ae81ff">0.00</span><span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PASS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ok</span>      <span style="color:#a6e22e">example</span> <span style="color:#ae81ff">0.040</span><span style="color:#a6e22e">s</span>
</span></span></code></pre></div><h3 id="17-包package和模块modules">17. 包(Package)和模块(Modules)<a hidden class="anchor" aria-hidden="true" href="#17-包package和模块modules">#</a></h3>
<h4 id="171-package">17.1 Package<a hidden class="anchor" aria-hidden="true" href="#171-package">#</a></h4>
<p>一般来说，一个文件夹可以作为 package，同一个 package 内部变量、类型、方法等定义可以相互看到。</p>
<p>比如我们新建一个文件 <code>calc.go</code>， <code>main.go</code> 平级，分别定义 add 和 main 方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// calc.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">num1</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">num2</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">num2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>)) <span style="color:#75715e">// 8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>运行 <code>go run main.go</code>，会报错，add 未定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>.<span style="color:#f92672">/</span><span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">14</span>: <span style="color:#a6e22e">undefined</span>: <span style="color:#a6e22e">add</span>
</span></span></code></pre></div><p>因为 <code>go run main.go</code> 仅编译 main.go 一个文件，所以命令需要换成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">calc</span>.<span style="color:#66d9ef">go</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p>或</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> .
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p>Go 语言也有 Public 和 Private 的概念，粒度是包。如果类型/接口/方法/函数/字段的首字母大写，则是 Public 的，对其他 package 可见，如果首字母小写，则是 Private 的，对其他 package 不可见。</p>
<h4 id="172-modules">17.2 Modules<a hidden class="anchor" aria-hidden="true" href="#172-modules">#</a></h4>
<p><a href="https://github.com/golang/go/wiki/Modules">Go Modules</a> 是 Go 1.11 版本之后引入的，Go 1.11 之前使用 $GOPATH 机制。Go Modules 可以算作是较为完善的包管理工具。同时支持代理，国内也能享受高速的第三方包镜像服务。接下来简单介绍 <code>go mod</code> 的使用。Go Modules 在 1.13 版本仍是可选使用的，环境变量 GO111MODULE 的值默认为 AUTO，强制使用 Go Modules 进行依赖管理，可以将 GO111MODULE 设置为 ON。</p>
<p>在一个空文件夹下，初始化一个 Module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">mod</span> <span style="color:#a6e22e">init</span> <span style="color:#a6e22e">example</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">go</span>: <span style="color:#a6e22e">creating</span> <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">go</span>.<span style="color:#a6e22e">mod</span>: <span style="color:#a6e22e">module</span> <span style="color:#a6e22e">example</span>
</span></span></code></pre></div><p>此时，在当前文件夹下生成了<code>go.mod</code>，这个文件记录当前模块的模块名以及所有依赖包的版本。</p>
<p>接着，我们在当前目录下新建文件 <code>main.go</code>，添加如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;rsc.io/quote&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">quote</span>.<span style="color:#a6e22e">Hello</span>())  <span style="color:#75715e">// Ahoy, world!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>运行 <code>go run .</code>，将会自动触发第三方包 <code>rsc.io/quote</code>的下载，具体的版本信息也记录在了<code>go.mod</code>中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">module</span> <span style="color:#a6e22e">example</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#ae81ff">1.13</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">require</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">quote</span> <span style="color:#a6e22e">v3</span><span style="color:#ae81ff">.1.0</span><span style="color:#f92672">+</span><span style="color:#a6e22e">incompatible</span>
</span></span></code></pre></div><p>我们在当前目录，添加一个子 package calc，代码目录如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">demo</span><span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>   |<span style="color:#f92672">--</span><span style="color:#a6e22e">calc</span><span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>      |<span style="color:#f92672">--</span><span style="color:#a6e22e">calc</span>.<span style="color:#66d9ef">go</span>
</span></span><span style="display:flex;"><span>   |<span style="color:#f92672">--</span><span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// calc.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">calc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">num1</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">num2</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">num1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">num2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在 package main 中如何使用 package cal 中的 Add 函数呢？<code>import 模块名/子目录名</code> 即可，修改后的 main 函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;example/calc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;rsc.io/quote&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">quote</span>.<span style="color:#a6e22e">Hello</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">run</span> .
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Ahoy</span>, <span style="color:#a6e22e">world</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>
</span></span></code></pre></div><pre tabindex="0"><code># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;
# !! Contents within this block are managed by &#39;conda init&#39; !!
__conda_setup=&#34;$(&#39;/Users/hzpan/anaconda3/bin/conda&#39; &#39;shell.bash&#39; &#39;hook&#39; 2&gt; /dev/null)&#34;
if [ $? -eq 0 ]; then
    eval &#34;$__conda_setup&#34;
else
    if [ -f &#34;/Users/hzpan/anaconda3/etc/profile.d/conda.sh&#34; ]; then
        . &#34;/Users/hzpan/anaconda3/etc/profile.d/conda.sh&#34;
    else
        export PATH=&#34;/Users/hzpan/anaconda3/bin:$PATH&#34;
    fi
fi
unset __conda_setup

/opt/anaconda3/bin/conda
# &lt;&lt;&lt; conda initialize &lt;&lt;&lt;
</code></pre><h3 id="18-rand">18. rand<a hidden class="anchor" aria-hidden="true" href="#18-rand">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Rand</span>) <span style="color:#a6e22e">Int</span>() <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Rand</span>) <span style="color:#a6e22e">Int31</span>() <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Rand</span>) <span style="color:#a6e22e">Int63</span>() <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Rand</span>) <span style="color:#a6e22e">Uint32</span>() <span style="color:#66d9ef">uint32</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Rand</span>) <span style="color:#a6e22e">Float32</span>() <span style="color:#66d9ef">float32</span>	<span style="color:#75715e">// 返回一个取值范围在[0.0, 1.0)的伪随机float32值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Rand</span>) <span style="color:#a6e22e">Float64</span>() <span style="color:#66d9ef">float64</span>	<span style="color:#75715e">// 返回一个取值范围在[0.0, 1.0)的伪随机float64值
</span></span></span></code></pre></div><h3 id="19-syncmap">19. sync.Map<a hidden class="anchor" aria-hidden="true" href="#19-syncmap">#</a></h3>
<h4 id="什么是-syncmap">什么是 sync.Map？<a hidden class="anchor" aria-hidden="true" href="#什么是-syncmap">#</a></h4>
<p>Go 语言原生 map 并不是线程安全的，对它进行并发读写操作的时候，需要加锁。而 <code>sync.map</code> 则是一种并发安全的 map，在 Go 1.9 引入。</p>
<blockquote>
<p><code>sync.map</code> 是线程安全的，读取，插入，删除也都保持着常数级的时间复杂度。
<code>sync.map</code> 的零值是有效的，并且零值是一个空的 map。在第一次使用之后，不允许被拷贝。</p>
</blockquote>
<h4 id="什么是-cas-机制">什么是 CAS 机制？<a hidden class="anchor" aria-hidden="true" href="#什么是-cas-机制">#</a></h4>
<p>CAS，是Compare and Swap的简称，在这个机制中有三个核心的参数：</p>
<ul>
<li>主内存中存放的共享变量的值：V（一般情况下这个V是内存的地址值，通过这个地址可以获得内存中的值）</li>
<li>工作内存中共享变量的副本值，也叫预期值：A</li>
<li>需要将共享变量更新到的最新值：B</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/perhapzz/ImageBed/main/blog-images/202302281035962.jpeg" alt="img"  />
</p>
<p>如上图中，主存中保存 V 值，线程中要使用 V 值要先从主存中读取 V 值到线程的工作内存A中，然后计算后变成 B 值，最后再把 B 值写回到内存 V 值中。多个线程共用 V 值都是如此操作。 CAS 的核心是在将 B 值写入到 V 之前要比较 A 值和 V 值是否相同，如果不相同证明此时 V 值已经被其他线程改变，重新将 V 值赋给 A，并重新计算得到 B，如果相同，则将 B 值赋给 V。</p>
<p>值得注意的是 CAS 机制中的这步步骤是原子性的（从指令层面提供的原子操作），所以 CAS 机制可以解决多线程并发编程对共享变量读写的原子性问题。</p>
<h4 id="cas机制优缺点">CAS机制优缺点<a hidden class="anchor" aria-hidden="true" href="#cas机制优缺点">#</a></h4>
<h5 id="缺点">缺点<a hidden class="anchor" aria-hidden="true" href="#缺点">#</a></h5>
<p><strong>1. ABA 问题</strong>
ABA 问题：CAS 在操作的时候会检查变量的值是否被更改过，如果没有则更新值，但是带来一个问题，最开始的值是 A，接着变成 B，最后又变成了 A。经过检查这个值确实没有修改过，因为最后的值还是 A，但是实际上这个值确实已经被修改过了。为了解决这个问题，在每次进行操作的时候加上一个版本号，每次操作的就是两个值，一个版本号和某个值，A——&gt;B——&gt;A 问题就变成了 1A——&gt;2B——&gt;3A。</p>
<p><strong>2. 可能会消耗较高的 CPU</strong>
看起来 CAS 比锁的效率高，从阻塞机制变成了非阻塞机制，减少了线程之间等待的时间。每个方法不能绝对的比另一个好，在线程之间竞争程度大的时候，如果使用 CAS，每次都有很多的线程在竞争，也就是说 CAS 机制不能更新成功。这种情况下 CAS 机制会一直重试，这样就会比较耗费 CPU。因此可以看出，如果线程之间竞争程度小，使用 CAS 是一个很好的选择；但是如果竞争很大，使用锁可能是个更好的选择。在并发量非常高的环境中，如果仍然想通过原子类来更新的话，可以使用 AtomicLong 的替代类：LongAdder。</p>
<p><strong>3. 不能保证代码块的原子性</strong>
Java 中的 CAS 机制只能保证共享变量操作的原子性，而不能保证代码块的原子性。</p>
<h4 id="优点">优点<a hidden class="anchor" aria-hidden="true" href="#优点">#</a></h4>
<ul>
<li>可以保证变量操作的原子性；</li>
<li>并发量不是很高的情况下，使用 CAS 机制比使用锁机制效率更高；</li>
<li>在线程对共享资源占用时间较短的情况下，使用 CAS 机制效率也会较高。</li>
</ul>
<h4 id="源码分析">源码分析<a hidden class="anchor" aria-hidden="true" href="#源码分析">#</a></h4>
<p><code>map</code> 的数据结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Map</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span> <span style="color:#75715e">// readOnly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dirty</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#f92672">*</span><span style="color:#a6e22e">entry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">misses</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>互斥量 <code>mu</code> 保护 <code>read</code> 和 <code>dirty</code>。</p>
<p><code>read</code> 是 <code>atomic.Value</code> 类型，可以并发地读。但如果需要更新 <code>read</code>，则需要加锁保护。对于 read 中存储的 entry 字段，可能会被并发地 CAS 更新。但是如果要更新一个之前已被删除的 entry，则需要先将其状态从 expunged 改为 nil，再拷贝到 dirty 中，然后再更新。</p>
<p><code>dirty</code> 是一个非线程安全的原始 map。包含新写入的 key，并且包含 <code>read</code> 中的所有未被删除的 key。这样，可以快速地将 <code>dirty</code> 提升为 <code>read</code> 对外提供服务。如果 <code>dirty</code> 为 nil，那么下一次写入时，会新建一个新的 <code>dirty</code>，这个初始的 <code>dirty</code> 是 <code>read</code> 的一个拷贝，但除掉了其中已被删除的 key。</p>
<p>每当从 read 中读取失败，都会将 <code>misses</code> 的计数值加 1，当加到一定阈值以后，需要将 dirty 提升为 read，以期减少 miss 的情形。</p>
<p>真正存储 <code>key/value</code> 的是 read 和 dirty 字段。<code>read</code> 使用 atomic.Value，这是 lock-free 的基础，保证 load/store 的原子性。<code>dirty</code> 则直接用了一个原始的 map，对于它的 load/store 操作需要加锁。</p>
<h2 id="常见用法">常见用法<a hidden class="anchor" aria-hidden="true" href="#常见用法">#</a></h2>
<h3 id="1-排序">1. 排序<a hidden class="anchor" aria-hidden="true" href="#1-排序">#</a></h3>
<h4 id="排序整数浮点数和字符串切片">排序整数、浮点数和字符串切片<a hidden class="anchor" aria-hidden="true" href="#排序整数浮点数和字符串切片">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//sort.Ints
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//sort.Floats
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//sort.Strings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Ints</span>(<span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">s</span>) <span style="color:#75715e">// 输出[1 2 3 4]
</span></span></span></code></pre></div><h4 id="使用自定义比较器排序">使用自定义比较器排序<a hidden class="anchor" aria-hidden="true" href="#使用自定义比较器排序">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">family</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}{
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;Alice&#34;</span>, <span style="color:#ae81ff">23</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;David&#34;</span>, <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;Eve&#34;</span>, <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;Bob&#34;</span>, <span style="color:#ae81ff">25</span>},
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 用 age 排序，年龄相等的元素保持原始顺序
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">SliceStable</span>(<span style="color:#a6e22e">family</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">family</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Age</span> &lt; <span style="color:#a6e22e">family</span>[<span style="color:#a6e22e">j</span>].<span style="color:#a6e22e">Age</span>
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">family</span>) <span style="color:#75715e">// [{David 2} {Eve 2} {Alice 23} {Bob 25}]
</span></span></span></code></pre></div><h3 id="2-searchints">2. SearchInts<a hidden class="anchor" aria-hidden="true" href="#2-searchints">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// search 源码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SearchInts</span>(<span style="color:#a6e22e">a</span> []<span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">x</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Search</span>(len(<span style="color:#a6e22e">a</span>), <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">x</span> })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Search</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">f</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Define f(-1) == false and f(n) == true.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Invariant: f(i-1) == false, f(j) == true.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">j</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> int(uint(<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#a6e22e">j</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// avoid overflow when computing h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// i ≤ h &lt; j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">h</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">i</span> = <span style="color:#a6e22e">h</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e">// preserves f(i-1) == false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">j</span> = <span style="color:#a6e22e">h</span> <span style="color:#75715e">// preserves f(j) == true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// i == j, f(i-1) == false, and f(j) (= f(i)) == true  =&gt;  answer is i.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="排序任意数据结构">排序任意数据结构<a hidden class="anchor" aria-hidden="true" href="#排序任意数据结构">#</a></h4>
<ul>
<li>使用<code>sort.Sort</code>或者<code>sort.Stable</code>函数。</li>
<li>他们可以排序实现了sort.Interface接口的任意类型</li>
</ul>
<p>一个内置的排序算法需要知道三个东西：序列的长度，表示两个元素比较的结果，一种交换两个元素的方式；这就是sort.Interface的三个方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Interface</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> <span style="color:#75715e">// i, j 是元素的索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>还是以上面的结构体切片为例子，我们为切片类型自定义一个类型名，然后在自定义的类型上实现 srot.Interface 接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Person</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Age</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ByAge 通过对age排序实现了sort.Interface接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ByAge</span> []<span style="color:#a6e22e">Person</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#a6e22e">ByAge</span>) <span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span>           { <span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">a</span>) }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#a6e22e">ByAge</span>) <span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Age</span> &lt; <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span>].<span style="color:#a6e22e">Age</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#a6e22e">ByAge</span>) <span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>)      { <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">i</span>] }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">family</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">Person</span>{
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;David&#34;</span>, <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;Alice&#34;</span>, <span style="color:#ae81ff">23</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;Eve&#34;</span>, <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#34;Bob&#34;</span>, <span style="color:#ae81ff">25</span>},
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Sort</span>(<span style="color:#a6e22e">ByAge</span>(<span style="color:#a6e22e">family</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">family</span>) <span style="color:#75715e">// [{David, 2} {Eve 2} {Alice 23} {Bob 25}]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>实现了sort.Interface的具体类型不一定是切片类型；下面的customSort是一个结构体类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">customSort</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">p</span>    []<span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">less</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>) <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">x</span> <span style="color:#a6e22e">customSort</span>) <span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span> {len(<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>)}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">x</span> <span style="color:#a6e22e">customSort</span>) <span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">less</span>(<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">j</span>]) }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">x</span> <span style="color:#a6e22e">customSort</span>) <span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>)      { <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>] }
</span></span></code></pre></div><p>让我们定义一个根据多字段排序的函数，它主要的排序键是Age，Age 相同了再按 Name 进行倒序排序。下面是该排序的调用，其中这个排序使用了匿名排序函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Sort</span>(<span style="color:#a6e22e">customSort</span>{<span style="color:#a6e22e">persons</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Person</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">Age</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">Age</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">Age</span> &lt; <span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">Age</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">Name</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">Name</span> &gt; <span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">Name</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}})
</span></span></code></pre></div><h3 id="3-优先队列实现">3. 优先队列实现<a hidden class="anchor" aria-hidden="true" href="#3-优先队列实现">#</a></h3>
<p><a href="https://leetcode-cn.com/problems/course-schedule-iii/">630. 课程表 III</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Heap</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">IntSlice</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">Heap</span>) <span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">IntSlice</span>[<span style="color:#a6e22e">i</span>] &gt; <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">IntSlice</span>[<span style="color:#a6e22e">j</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Heap</span>) <span style="color:#a6e22e">Push</span>(<span style="color:#a6e22e">x</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">IntSlice</span> = append(<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">IntSlice</span>, <span style="color:#a6e22e">x</span>.(<span style="color:#66d9ef">int</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Heap</span>) <span style="color:#a6e22e">Pop</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">IntSlice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>[len(<span style="color:#a6e22e">a</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">IntSlice</span> = <span style="color:#a6e22e">a</span>[:len(<span style="color:#a6e22e">a</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//courses = [[100, 200], [200, 1300], [1000, 1250], [2000, 3200]]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Heap</span>{}
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// heap.Push(h, t)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  	<span style="color:#75715e">// heap.Fix(h, 0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://perhapzz.github.io/tags/golang/">golang</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://perhapzz.github.io">perhapzz</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
