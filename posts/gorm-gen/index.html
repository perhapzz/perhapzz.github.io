<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>gorm-gen 学习笔记 | perhapzz</title>
<meta name="keywords" content="golang, gorm">
<meta name="description" content="gen 通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）">
<meta name="author" content="">
<link rel="canonical" href="https://perhapzz.github.io/posts/gorm-gen/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2c5d624023ca4f39285dc8ad242509c565a0c0e820fc61724b2a58620dfdafbe.css" integrity="sha256-LF1iQCPKTzkoXcitJCUJxWWgwOgg/GFySypYYg39r74=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://perhapzz.github.io/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://perhapzz.github.io/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://perhapzz.github.io/favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://perhapzz.github.io/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://perhapzz.github.io/favicon/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="gorm-gen 学习笔记" />
<meta property="og:description" content="gen 通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://perhapzz.github.io/posts/gorm-gen/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-26T00:24:03+08:00" />
<meta property="article:modified_time" content="2023-01-26T00:24:03+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="gorm-gen 学习笔记"/>
<meta name="twitter:description" content="gen 通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://perhapzz.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "gorm-gen 学习笔记",
      "item": "https://perhapzz.github.io/posts/gorm-gen/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "gorm-gen 学习笔记",
  "name": "gorm-gen 学习笔记",
  "description": "gen 通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）",
  "keywords": [
    "golang", "gorm"
  ],
  "articleBody": "问题 SQL 注入 Object Relational Mapping 的定位就是帮助开发者减轻心智负担，你不用再去思考业务 object 和 数据表 relation 之间的对应，ORM 框架来帮你完成。我们只需要简单的在 object 上加上 tag，剩下怎么拼 SQL，怎么 Scan 数据后写入 object 就交给 ORM 来完成。业务开发者不需要操心这个。\n问题就在这里，这样的定位势必导致 ORM 被反射和 interface{} 满天飞，你既然要通用，按照 Golang 目前的能力，就势必要在运行时做类型转换，用各种反射黑科技。但是，反射顶多能告诉你当前是什么，不能来校验。因为 ORM 是不感知业务的。要求它来校验输入数据的类型，格式，合法性是不现实的。使用方法十分灵活的查询接口很容易造成研发对接口的误用，从而导致 SQL 注入。\n复杂 SQL GORM 作为 ORM 框架并没有提供任何辅助代码开发的功能，导致面对较为复杂的数据库表查询场景时，开发者需逐条手写数据表中的列与对应结构体的成员变量，单调且重复的查询功能也需要手动复制，稍不注意就会造成不易察觉的拼写错误。\n其实在 Golang 泛型比较弱的情况下，使用代码生成依然是解决个性化场景的经典方案，这样绕开了 interface{}，我们就可以做更多校验，也省去了断言。GORM 其实也是基于这个思路，推出了自己的代码生成工具：Gen。\n总结 gen 对自己的定位就是通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）。\n从真正使用上来说，我觉得最核心的 feature 在于：\n 字段类型校验，过滤参数错误，为数字、字符串、布尔类型、时间类型硬编码制定差异化类型安全的表达式方法，杜绝了 SQL 注入的风险，能跑就安全； 映射数据库表像，DB 里面有数据表就能生成对应的 Golang 结构体； 用注释的形式描述查询的逻辑后，一键即可生成对应的安全可靠查询API。  此外还有一个好处是，我们用 GORM 来 Find 数据时，总还是要先声明结果，然后把指针传入 API，由 GORM 进行填充，而有了 Gen 之后，直接返回对应的数据结构，免于提前实例化数据后在注入API的繁琐。\n注释规则 占位符   gen.T 用于返回数据的结构体，会根据生成结构体或者数据库表结构自动生成\n  gen.M 表示map[string]interface{}，用于返回数据\n  gen.RowsAffected 用于执行SQL进行更新或删除时候,用于返回影响行数\n  @@table 查询的表名，如果没有传参，会根据结构体或者表名自动生成\n  @@ 当表名或者字段名可控时候，用@@占位，name为可变参数名，需要函数传入\n  @ 当数据可控时候，用@占位，name为可变参数名，需要函数传入\n  出于安全拼接考虑，like查询不支持在SQL中拼接%，如需要拼接，需要在调用函数参数中拼接好\n  子句   逻辑操作必须包裹在{{}}中，如{{if}},结束语句必须是 {{end}}, 所有的语句都可以嵌套。{{}}中的语法除了{{end}}其它的都是Golang语法\n  {{if}} 支持通过满足条件拼接字符串到SQL\n  where 只有在where子句不为空时候插入where，若子句的开头为 where连接关键字AND 或 OR，会将它们去除\n  set 只有在set子句不为空时候插入set，若子句的开头为,会将它们去除\n  for 通过遍历数组并将其内容插入到SQL中,需要注意之前的连接词。\n  所有子句需要用{{end}} 结束子句，支持嵌套使用\n  实战演练 文件目录：\ngormgen ├── dal │ ├── dal.go │ ├── model │ │ ├── method.go │ │ └── model.go │ └── query │ ├── gen.go │ └── users.gen.go ├── gen │ └── gen.go ├── generate.sh ├── go.mod ├── go.sum └── main.go   cmd/generate ：用于存放 gorm-gen 的代码生成逻辑；\n  dal/model ：我们的业务结构定义(model.go)，以及希望 gorm-gen 生成实现的接口定义（method.go)；\n  generate.sh ：一个bash 脚本，启动代码生成。\n  // dal/dal.go // 维护了内存中的数据库连接，完成初始化，和业务无关  var DB *gorm.DB var once sync.Once  func init() { \tonce.Do(func() { \tDB = ConnctDB().Debug() \t_ = DB.AutoMigrate(\u0026model.User{}) \t}) }  func ConnctDB() (conn *gorm.DB) { \tconn, err := gorm.Open(mysql.Open(\"gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8\u0026parseTime=True\u0026loc=Local\"), \u0026gorm.Config{}) \tif err != nil { \tpanic(err) \t} \treturn conn } // model/method.go // 定义希望实现的接口定义，本质是通过【注释】告诉 gen，我们希望获取什么样的数据，sql 怎么生成  type UserMethod interface { \t//where(id=@id) \tFindByID(id int) (gen.T, error)  \t//where(username=@username) \tFindByUsername(username string) (gen.T, error) } // model/model.go // 定义业务模型：User  type User struct { \tgorm.Model \tId uint `gorm:\"primary_key\"` \tName string `gorm:\"column:name\"` \tUsername string `gorm:\"column:username\"` \tPassword string `gorm:\"column:password\"` } // gen/gen.go // 告诉 gorm-gen 如何生成  func main() { \t// 我们通过 gen.NewGenerator 来构造一个【代码生成器】，指定我们要生成的代码要放到 dal 下面的 query 子包，生成模式暂时用 default 就ok \tg := gen.NewGenerator(gen.Config{ \tOutPath: \"../dal/query\", \tMode: gen.WithDefaultQuery, \t})  \t// 调用 ApplyBasic 基于 model 来生成基础 DAL 代码 \tg.ApplyBasic(model.User{})  \t// 调用 ApplyInterface，指明我们希望基于什么 model 和 interface 来生成自定义的接口实现 \tg.ApplyInterface(func(model.UserMethod) {}, model.User{})  \t// 最后调用 Execute 方法来触发生成 \tg.Execute() } 生成 # gen 目录下运行 gen.go $ go run .  2023/01/26 00:02:35 Start generating code. 2023/01/26 00:02:35 generate query file: /home/phzbbb/gormgen/dal/query/users.gen.go 2023/01/26 00:02:35 generate query file: /home/phzbbb/gormgen/dal/query/gen.go 2023/01/26 00:02:35 Generate code done. 测试 // main.go  var q = query.Use(dal.DB.Debug())  func Create(ctx context.Context) { \tvar err error \tuserDatabase := q.User.WithContext(ctx)  \tuserData := \u0026model.User{Name: \"hzpan\", Username: \"phzbbb\", Password: \"1234\"} \terr = userDatabase.Create(userData) \tif err != nil { \tpanic(err) \t} }  func Query(ctx context.Context) { \tuserDatabase := q.User.WithContext(ctx)  \tuser, err := userDatabase.FindByUsername(\"phzbbb\") \tif err != nil { \tpanic(err) \t} \tfmt.Printf(\"query 1 item: %+v\", user) }  func main() { \tctx := context.Background()  \tCreate(ctx)  \tQuery(ctx) } # gormgen 目录下运行 main.go $ go run .  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [0.302ms] [rows:-] SELECT DATABASE()  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [2.840ms] [rows:1] SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE 'gorm%' ORDER BY SCHEMA_NAME='gorm' DESC,SCHEMA_NAME limit 1  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [2.249ms] [rows:-] SELECT count(*) FROM information_schema.tables WHERE table_schema = 'gorm' AND table_name = 'users' AND table_type = 'BASE TABLE'  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [0.316ms] [rows:-] SELECT DATABASE()  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [1.056ms] [rows:1] SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE 'gorm%' ORDER BY SCHEMA_NAME='gorm' DESC,SCHEMA_NAME limit 1  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [0.446ms] [rows:-] SELECT * FROM `users` LIMIT 1  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [2.631ms] [rows:-] SELECT column_name, column_default, is_nullable = 'YES', data_type, character_maximum_length, column_type, column_key, extra, column_comment, numeric_precision, numeric_scale , datetime_precision FROM information_schema.columns WHERE table_schema = 'gorm' AND table_name = 'users' ORDER BY ORDINAL_POSITION  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [0.410ms] [rows:-] SELECT DATABASE()  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [0.978ms] [rows:1] SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE 'gorm%' ORDER BY SCHEMA_NAME='gorm' DESC,SCHEMA_NAME limit 1  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19 [1.522ms] [rows:-] SELECT count(*) FROM information_schema.statistics WHERE table_schema = 'gorm' AND table_name = 'users' AND index_name = 'idx_users_deleted_at'  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/query/users.gen.go:256 [4.503ms] [rows:1] INSERT INTO `users` (`created_at`,`updated_at`,`deleted_at`,`name`,`username`,`password`) VALUES ('2023-01-26 00:01:21.709','2023-01-26 00:01:21.709',NULL,'hzpan','phzbbb','1234')  2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/query/users.gen.go:151 [1.374ms] [rows:1] SELECT * FROM `users` WHERE username='phzbbb' AND `users`.`deleted_at` IS NULL LIMIT 1 phzbbb@LAPTOP-N7JGIRHR:~/gormgen$ At:{Time:0001-01-01 00:00:00 +0000 UTC Valid:false}} Id:1 Name:hzpan User 参考\ngorm 代码生成工具：gen\n",
  "wordCount" : "609",
  "inLanguage": "en",
  "datePublished": "2023-01-26T00:24:03+08:00",
  "dateModified": "2023-01-26T00:24:03+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://perhapzz.github.io/posts/gorm-gen/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "perhapzz",
    "logo": {
      "@type": "ImageObject",
      "url": "https://perhapzz.github.io/favicon/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://perhapzz.github.io" accesskey="h" title="perhapzz (Alt + H)">perhapzz</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://perhapzz.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://perhapzz.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://perhapzz.github.io">Home</a>&nbsp;»&nbsp;<a href="https://perhapzz.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      gorm-gen 学习笔记
    </h1>
    <div class="post-description">
      gen 通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）
    </div>
    <div class="post-meta"><span title='2023-01-26 00:24:03 +0800 CST'>January 26, 2023</span>

</div>
  </header> 
  <div class="post-content"><h2 id="问题">问题<a hidden class="anchor" aria-hidden="true" href="#问题">#</a></h2>
<h3 id="sql-注入">SQL 注入<a hidden class="anchor" aria-hidden="true" href="#sql-注入">#</a></h3>
<p>Object Relational Mapping 的定位就是帮助开发者减轻心智负担，你不用再去思考业务 object 和 数据表 relation 之间的对应，ORM 框架来帮你完成。我们只需要简单的在 object 上加上 tag，剩下怎么拼 SQL，怎么 Scan 数据后写入 object 就交给 ORM 来完成。业务开发者不需要操心这个。</p>
<p>问题就在这里，这样的定位势必导致 ORM 被反射和 interface{} 满天飞，你既然要通用，按照 Golang 目前的能力，就势必要在运行时做类型转换，用各种反射黑科技。但是，反射顶多能告诉你当前是什么，不能来校验。因为 ORM 是不感知业务的。要求它来校验输入数据的类型，格式，合法性是不现实的。使用方法十分灵活的查询接口很容易造成研发对接口的误用，从而导致 SQL 注入。</p>
<h3 id="复杂-sql">复杂 SQL<a hidden class="anchor" aria-hidden="true" href="#复杂-sql">#</a></h3>
<p>GORM 作为 ORM 框架并没有提供任何辅助代码开发的功能，导致面对较为复杂的数据库表查询场景时，开发者需逐条手写数据表中的列与对应结构体的成员变量，单调且重复的查询功能也需要手动复制，稍不注意就会造成不易察觉的拼写错误。</p>
<p>其实在 Golang 泛型比较弱的情况下，使用<strong>代码生成</strong>依然是解决个性化场景的经典方案，这样绕开了 interface{}，我们就可以做更多校验，也省去了断言。GORM 其实也是基于这个思路，推出了自己的代码生成工具：Gen。</p>
<h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p>gen 对自己的定位就是通过代码生成，让 GORM 更加友好（针对复杂SQL场景也能处理），也更加安全（增加类型校验）。</p>
<p>从真正使用上来说，我觉得最核心的 feature 在于：</p>
<ol>
<li>字段类型校验，过滤参数错误，为数字、字符串、布尔类型、时间类型硬编码制定差异化类型安全的表达式方法，杜绝了 SQL 注入的风险，能跑就安全；</li>
<li>映射数据库表像，DB 里面有数据表就能生成对应的 Golang 结构体；</li>
<li>用注释的形式描述查询的逻辑后，一键即可生成对应的安全可靠查询API。</li>
</ol>
<p>此外还有一个好处是，我们用 GORM 来 Find 数据时，总还是要先声明结果，然后把指针传入 API，由 GORM 进行填充，而有了 Gen 之后，直接返回对应的数据结构，免于提前实例化数据后在注入API的繁琐。</p>
<h2 id="注释规则">注释规则<a hidden class="anchor" aria-hidden="true" href="#注释规则">#</a></h2>
<h3 id="占位符">占位符<a hidden class="anchor" aria-hidden="true" href="#占位符">#</a></h3>
<ul>
<li>
<p><code>gen.T</code> 用于返回数据的结构体，会根据生成结构体或者数据库表结构自动生成</p>
</li>
<li>
<p><code>gen.M</code> 表示<code>map[string]interface{}</code>，用于返回数据</p>
</li>
<li>
<p><code>gen.RowsAffected</code> 用于执行SQL进行更新或删除时候,用于返回影响行数</p>
</li>
<li>
<p><code>@@table</code> 查询的表名，如果没有传参，会根据结构体或者表名自动生成</p>
</li>
<li>
<p><code>@@&lt;name&gt;</code> 当表名或者字段名可控时候，用@@占位，name为可变参数名，需要函数传入</p>
</li>
<li>
<p><code>@&lt;name&gt;</code> 当数据可控时候，用@占位，name为可变参数名，需要函数传入</p>
</li>
<li>
<p>出于安全拼接考虑，like查询不支持在SQL中拼接%，如需要拼接，需要在调用函数参数中拼接好</p>
</li>
</ul>
<h3 id="子句">子句<a hidden class="anchor" aria-hidden="true" href="#子句">#</a></h3>
<ul>
<li>
<p>逻辑操作必须包裹在<code>{{}}</code>中，如<code>{{if}}</code>,结束语句必须是 <code>{{end}}</code>, 所有的语句都可以嵌套。<code>{{}}</code>中的语法除了<code>{{end}}</code>其它的都是Golang语法</p>
</li>
<li>
<p><code>{{if}}</code> 支持通过满足条件拼接字符串到SQL</p>
</li>
<li>
<p><code>where</code> 只有在where子句不为空时候插入where，若子句的开头为 where连接关键字<code>AND</code> 或 <code>OR</code>，会将它们去除</p>
</li>
<li>
<p><code>set</code> 只有在set子句不为空时候插入set，若子句的开头为<code>,</code>会将它们去除</p>
</li>
<li>
<p><code>for</code> 通过遍历数组并将其内容插入到SQL中,需要注意之前的连接词。</p>
</li>
<li>
<p>所有子句需要用<code>{{end}}</code> 结束子句，支持嵌套使用</p>
</li>
</ul>
<h2 id="实战演练">实战演练<a hidden class="anchor" aria-hidden="true" href="#实战演练">#</a></h2>
<p><strong>文件目录：</strong></p>
<pre tabindex="0"><code>gormgen
├── dal
│   ├── dal.go
│   ├── model
│   │   ├── method.go
│   │   └── model.go
│   └── query
│       ├── gen.go
│       └── users.gen.go
├── gen
│   └── gen.go
├── generate.sh
├── go.mod
├── go.sum
└── main.go
</code></pre><ul>
<li>
<p><code>cmd/generate</code> ：用于存放 gorm-gen 的代码生成逻辑；</p>
</li>
<li>
<p><code>dal/model</code> ：我们的业务结构定义(model.go)，以及希望 gorm-gen 生成实现的接口定义（method.go)；</p>
</li>
<li>
<p><code>generate.sh</code> ：一个bash 脚本，启动代码生成。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// dal/dal.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 维护了内存中的数据库连接，完成初始化，和业务无关
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DB</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">once</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">once</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DB</span> = <span style="color:#a6e22e">ConnctDB</span>().<span style="color:#a6e22e">Debug</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">AutoMigrate</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>{})
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ConnctDB</span>() (<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">mysql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Config</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">conn</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// model/method.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 定义希望实现的接口定义，本质是通过【注释】告诉 gen，我们希望获取什么样的数据，sql 怎么生成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserMethod</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//where(id=@id)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FindByID</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">gen</span>.<span style="color:#a6e22e">T</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//where(username=@username)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FindByUsername</span>(<span style="color:#a6e22e">username</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">gen</span>.<span style="color:#a6e22e">T</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// model/model.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 定义业务模型：User
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Model</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Id</span>       <span style="color:#66d9ef">uint</span>   <span style="color:#e6db74">`gorm:&#34;primary_key&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span>     <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;column:name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Username</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;column:username&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Password</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;column:password&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// gen/gen.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 告诉 gorm-gen 如何生成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 我们通过 gen.NewGenerator 来构造一个【代码生成器】，指定我们要生成的代码要放到 dal 下面的 query 子包，生成模式暂时用 default 就ok
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gen</span>.<span style="color:#a6e22e">NewGenerator</span>(<span style="color:#a6e22e">gen</span>.<span style="color:#a6e22e">Config</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">OutPath</span>: <span style="color:#e6db74">&#34;../dal/query&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Mode</span>:    <span style="color:#a6e22e">gen</span>.<span style="color:#a6e22e">WithDefaultQuery</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用 ApplyBasic 基于 model 来生成基础 DAL 代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">ApplyBasic</span>(<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>{})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用 ApplyInterface，指明我们希望基于什么 model 和 interface 来生成自定义的接口实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">ApplyInterface</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">UserMethod</span>) {}, <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>{})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 最后调用 Execute 方法来触发生成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Execute</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="生成">生成<a hidden class="anchor" aria-hidden="true" href="#生成">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># gen 目录下运行 gen.go</span>
</span></span><span style="display:flex;"><span>$ go run .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:02:35 Start generating code.
</span></span><span style="display:flex;"><span>2023/01/26 00:02:35 generate query file: /home/phzbbb/gormgen/dal/query/users.gen.go
</span></span><span style="display:flex;"><span>2023/01/26 00:02:35 generate query file: /home/phzbbb/gormgen/dal/query/gen.go
</span></span><span style="display:flex;"><span>2023/01/26 00:02:35 Generate code <span style="color:#66d9ef">done</span>.
</span></span></code></pre></div><h3 id="测试">测试<a hidden class="anchor" aria-hidden="true" href="#测试">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">q</span> = <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">dal</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Debug</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">userDatabase</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">WithContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">userData</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;hzpan&#34;</span>, <span style="color:#a6e22e">Username</span>: <span style="color:#e6db74">&#34;phzbbb&#34;</span>, <span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;1234&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">userDatabase</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">userData</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">userDatabase</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">WithContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userDatabase</span>.<span style="color:#a6e22e">FindByUsername</span>(<span style="color:#e6db74">&#34;phzbbb&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;query 1 item: %+v&#34;</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># gormgen 目录下运行 main.go</span>
</span></span><span style="display:flex;"><span>$ go run .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>0.302ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT DATABASE<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>2.840ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:1<span style="color:#f92672">]</span> SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE <span style="color:#e6db74">&#39;gorm%&#39;</span> ORDER BY SCHEMA_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gorm&#39;</span> DESC,SCHEMA_NAME limit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>2.249ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT count<span style="color:#f92672">(</span>*<span style="color:#f92672">)</span> FROM information_schema.tables WHERE table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gorm&#39;</span> AND table_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;users&#39;</span> AND table_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;BASE TABLE&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>0.316ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT DATABASE<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1.056ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:1<span style="color:#f92672">]</span> SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE <span style="color:#e6db74">&#39;gorm%&#39;</span> ORDER BY SCHEMA_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gorm&#39;</span> DESC,SCHEMA_NAME limit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>0.446ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT * FROM <span style="color:#e6db74">`</span>users<span style="color:#e6db74">`</span> LIMIT <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>2.631ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT column_name, column_default, is_nullable <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;YES&#39;</span>, data_type, character_maximum_length, column_type, column_key, extra, column_comment, numeric_precision, numeric_scale , datetime_precision FROM information_schema.columns WHERE table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gorm&#39;</span> AND table_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;users&#39;</span> ORDER BY ORDINAL_POSITION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>0.410ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT DATABASE<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>0.978ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:1<span style="color:#f92672">]</span> SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE <span style="color:#e6db74">&#39;gorm%&#39;</span> ORDER BY SCHEMA_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gorm&#39;</span> DESC,SCHEMA_NAME limit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/dal.go:19
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1.522ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:-<span style="color:#f92672">]</span> SELECT count<span style="color:#f92672">(</span>*<span style="color:#f92672">)</span> FROM information_schema.statistics WHERE table_schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gorm&#39;</span> AND table_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;users&#39;</span> AND index_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;idx_users_deleted_at&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/query/users.gen.go:256
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>4.503ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:1<span style="color:#f92672">]</span> INSERT INTO <span style="color:#e6db74">`</span>users<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>created_at<span style="color:#e6db74">`</span>,<span style="color:#e6db74">`</span>updated_at<span style="color:#e6db74">`</span>,<span style="color:#e6db74">`</span>deleted_at<span style="color:#e6db74">`</span>,<span style="color:#e6db74">`</span>name<span style="color:#e6db74">`</span>,<span style="color:#e6db74">`</span>username<span style="color:#e6db74">`</span>,<span style="color:#e6db74">`</span>password<span style="color:#e6db74">`</span><span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;2023-01-26 00:01:21.709&#39;</span>,<span style="color:#e6db74">&#39;2023-01-26 00:01:21.709&#39;</span>,NULL,<span style="color:#e6db74">&#39;hzpan&#39;</span>,<span style="color:#e6db74">&#39;phzbbb&#39;</span>,<span style="color:#e6db74">&#39;1234&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023/01/26 00:01:21 /home/phzbbb/gormgen/dal/query/users.gen.go:151
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1.374ms<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rows:1<span style="color:#f92672">]</span> SELECT * FROM <span style="color:#e6db74">`</span>users<span style="color:#e6db74">`</span> WHERE username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;phzbbb&#39;</span>  AND <span style="color:#e6db74">`</span>users<span style="color:#e6db74">`</span>.<span style="color:#e6db74">`</span>deleted_at<span style="color:#e6db74">`</span> IS NULL LIMIT <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>phzbbb@LAPTOP-N7JGIRHR:~/gormgen$
</span></span><span style="display:flex;"><span>At:<span style="color:#f92672">{</span>Time:0001-01-01 00:00:00 +0000 UTC Valid:false<span style="color:#f92672">}}</span> Id:1 Name:hzpan User
</span></span></code></pre></div><p><strong>参考</strong></p>
<p><a href="https://juejin.cn/post/7133150674400837668#heading-7">gorm 代码生成工具：gen</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://perhapzz.github.io/tags/golang/">golang</a></li>
      <li><a href="https://perhapzz.github.io/tags/gorm/">gorm</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://perhapzz.github.io">perhapzz</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
