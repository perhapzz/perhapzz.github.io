<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>迈出Go RPC的一小步 | perhapzz</title>
<meta name="keywords" content="golang">
<meta name="description" content="记Go语言远程过程调用RPC学习过程">
<meta name="author" content="">
<link rel="canonical" href="https://perhapzz.github.io/posts/firststepofrpc/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2c5d624023ca4f39285dc8ad242509c565a0c0e820fc61724b2a58620dfdafbe.css" integrity="sha256-LF1iQCPKTzkoXcitJCUJxWWgwOgg/GFySypYYg39r74=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://perhapzz.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://perhapzz.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://perhapzz.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://perhapzz.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://perhapzz.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="迈出Go RPC的一小步" />
<meta property="og:description" content="记Go语言远程过程调用RPC学习过程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://perhapzz.github.io/posts/firststepofrpc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-13T10:52:29+08:00" />
<meta property="article:modified_time" content="2022-12-13T10:52:29+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="迈出Go RPC的一小步"/>
<meta name="twitter:description" content="记Go语言远程过程调用RPC学习过程"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://perhapzz.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "迈出Go RPC的一小步",
      "item": "https://perhapzz.github.io/posts/firststepofrpc/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "迈出Go RPC的一小步",
  "name": "迈出Go RPC的一小步",
  "description": "记Go语言远程过程调用RPC学习过程",
  "keywords": [
    "golang"
  ],
  "articleBody": "参考：用Go语言从零开始撸一套RPC\n0. 新建一个Go项目 因为好久没写go了，所以这也算一步吧…\n# 新建一个目录 $ mkdir HandsOnGoRPC $ cd HandsOnGoRPC  # 初始化并写入一个新的go.mod至当前目录中，实际上是创建一个以当前目录为根的新模块。 $ go mod init $ go mod tidy 另外再顺便上个git\n$ git init $ git add . $ git commit -m \"initial commit\" $ git remote add origin https://github.com/perhapzz/HandsOnGoRPC.git # 带上-u 参数其实就相当于记录了push到远端分支的默认值，这样当下次我们还想要继续push的这个远端分支的时候推送命令就可以简写成git push即可 $ git push -u origin main 1. Hello RPC 描述 对于服务端， net/rpc 要求用一个导出的结构体来表示 RPC 服务，这个结构体中所有符合特定要求的方法就是提供给客户端访问的：\ntype T struct {}  func (t *T) MethodName(argType T1, replyType *T2) error // 结构体是导出的 // 方法是导出的 // 方法有两个参数，都是导出的类型（或者内置类型） // 方法的第二个参数是指针 // 方法的返回值是 error 服务端通过 rpc.Dial（对 TCP 服务）连接服务端，然后用使用 Call 调用 RPC 服务中的方法：\nrpc.Call(\"T.MethodName\", argType T1, replyType *T2) 代码 服务端 // server.go  // HelloService is a RPC service for helloWorld type HelloService struct{}  // Hello say hello to request func (p *HelloService) Hello(request string, reply *string) error { \t*reply = \"hello:\" + request \treturn nil }  func main() {  // 用将给客户端访问的名字和HelloService实例注册 RPC 服务 \trpc.RegisterName(\"HelloService\", new(HelloService))  \t// TCP 服务 \tlistener, err := net.Listen(\"tcp\", \":1234\") \tif err != nil { \tlog.Fatal(\"ListenTCP error:\", err) \t}   \tconn, err := listener.Accept() \tif err != nil { \tlog.Fatal(\"Accept error:\", err) \t}  \trpc.ServeConn(conn)  \t// 上述代码只 Accept 一个请求，在客户端请求过后就会自动关闭。如果需要一直保持处理，可以把后半部分代码换成 \t// for { \t// conn, err := listener.Accept() \t// if err != nil { \t// log.Fatal(\"Accept error:\", err) \t// } \t// // 开一个协程处理连接上的接口 \t// go rpc.ServeConn(conn) \t// } } 对于循环监听，我的理解：\n\tfor { \t// 开始监听 \tconn, err := listener.Accept() \t// 接收到请求开始进行后续程序 \tif err != nil { \tlog.Fatal(\"Accept error:\", err) \t}  \t// 开一个协程处理连接上的接口，主程序监听下一次请求 \tgo rpc.ServeConn(conn) \t} 客户端 // client.go package main  import ( \t\"fmt\" \t\"log\" \t\"net/rpc\" )  func main() { \tclient, err := rpc.Dial(\"tcp\", \"localhost:1234\") \tif err != nil { \tlog.Fatal(\"dialing:\", err) \t}  \tvar reply string \terr = client.Call(\"HelloService.Hello\", \"hello\", \u0026reply) \tif err != nil { \tlog.Fatal(err) \t}  \tfmt.Println(reply) } 2. 更规范的RPC接口 描述 之前的代码服务端、客户端的注册、调用 RPC 服务都是写死的。所有的工作都放到了一块，相当不利于维护，需要考虑重构 HelloService 服务和客户端实现。\n我们将RPC服务的接口规范分为3部分：\n 服务的名字 服务要实现的详细方法列表 注册该类型服务的函数  在客户端上也要针对HelloService服务的借口，做针对性的Client类型，这样客户端用户可以直接通过接口对应的方法调用RPC函数，同时提供DialHelloService()函数，直接拨号HelloService服务。\n客户的接口规范：\n 客户的名字，包含一个*rpc.Client 直接拨号指定服务的函数 客户直接调用指定方法的函数  这样做避免了RPC方法名字或参数类型不匹配等低级错误的发生，具体调用时也不用暴露处理 RPC 的细节了。\n代码 服务端 使用RegisterHelloService()函数来注册函数，这样不仅可以避免命名服务名称的工作，同时也保证了传入的服务对象满足RPC接口的定义。\n// server.go  type HelloService struct{}  func (p *HelloService) Hello(request string, reply *string) error { \t*reply = \"hello:\" + request \treturn nil }  // HelloServiceName is the name of HelloService const HelloServiceName = \"HelloService\"  // HelloServiceInterface is a interface for HelloService type HelloServiceInterface interface { \tHello(request string, reply *string) error }  // RegisterHelloService register the RPC service on svc func RegisterHelloService(svc HelloServiceInterface) error { \t// 返回rpc.RegisterName(HelloServiceName, svc)的报错信息 \treturn rpc.RegisterName(HelloServiceName, svc) }  func main() { \t// rpc.RegisterName(\"HelloService\", new(HelloService)) \tRegisterHelloService(new(HelloService))  \tlistener, err := net.Listen(\"tcp\", \":1234\") \tif err != nil { \tlog.Fatal(\"ListenTCP error:\", err) \t}  \tfor { \tconn, err := listener.Accept() \tif err != nil { \tlog.Fatal(\"Accept error:\", err) \t}  \tgo rpc.ServeConn(conn) \t} } 新的服务改为支持多个TCP链接，然后为每个TCP链接提供RPC服务。\n客户端 // client.go  // HelloServiceName is the name of HelloService const HelloServiceName = \"HelloService\"  // HelloServiceClient is a client for HelloService type HelloServiceClient struct { \t*rpc.Client }  // HelloServiceInterface is a interface for HelloService type HelloServiceInterface interface { \tHello(request string, reply *string) error }  // 测试接口定义 var _ HelloServiceInterface = (*HelloServiceClient)(nil)  // DialHelloService dial HelloService // 针对 HelloService 设计 Client func DialHelloService(network, address string) (*HelloServiceClient, error) { \tc, err := rpc.Dial(network, address) \tif err != nil { \treturn nil, err \t} \treturn \u0026HelloServiceClient{Client: c}, nil }  // Hello calls HelloService.Hello // 针对 HelloService 各个服务设计 Call 函数 func (p *HelloServiceClient) Hello(request string, reply *string) error { \treturn p.Client.Call(HelloServiceName+\".Hello\", request, reply) }  func main() { \tclient, err := DialHelloService(\"tcp\", \"localhost:1234\") \tif err != nil { \tlog.Fatal(\"dialing:\", err) \t}  \tvar reply string \terr = client.Hello(\"world\", \u0026reply) \tif err != nil { \tlog.Fatal(err) \t}  \tfmt.Println(reply) } 但我也没感觉这样更清爽，在服务端和客户端都定义了HelloServiceName和HelloServiceInterface，有点冗余。\n3. 计算器 RPC 服务 描述 用 RPC 服务实现一个计算器。\n因为服务端和客户端都需要定义RPC接口，那么可以写一个通用的，然后import进去。另外所有服务要实现的详细方法都在calc.go里定义，server.go和client.go只写 RPC 服务的实现和调用，使代码结构更清晰。\n代码 项目目录如下：\ncalc/ ├── calcrpc.go ├── client │ └── client.go └── server ├── calc.go └── server.go 首先写一个 calcrpc.go 定义服务端/客户端通用的 RPC 接口：\n// calcrpc.go // 定义 ClacService 的名字、详细方法列表和注册该类型服务的函数  // ServiceName 计算器服务名 const ServiceName = \"CalcService\"  // ServiceInterface 计算器服务接口 type ServiceInterface interface { \t// CalcTwoNumber 对两个数进行运算 \tCalcTwoNumber(request Calc, reply *float64) error \t// GetOperators 获取所有支持的运算 \tGetOperators(request struct{}, reply *[]string) error }  // RegisterCalcService register the RPC service on svc func RegisterCalcService(svc ServiceInterface) error { \treturn rpc.RegisterName(ServiceName, svc) }  // Calc 定义计算器对象，包括两个运算数 type Calc struct { \tNumber1 float64 \tNumber2 float64 \tOperator string } 服务端 在 calc.go 中写一个常规的计算器抽象实现：\n// calc.go // 实现简单计算器  /* 抽象的计算函数类型 */  // Operation 是计算的抽象 // 定义长 func(Number1, Number2 float64) float64 这样的可以用 Operation 来代替，并且是导出的 type Operation func(Number1, Number2 float64) float64  /* 加减乘除的具体 Operation 实现 */  // Add 是加法的 Operation 实现 func Add(Number1, Number2 float64) float64 { \treturn Number1 + Number2 }  // Sub 是减法的 Operation 实现 func Sub(Number1, Number2 float64) float64 { \treturn Number1 - Number2 }  // Mul 是乘法的 Operation 实现 func Mul(Number1, Number2 float64) float64 { \treturn Number1 * Number2 }  // Div 是除法的 Operation 实现 func Div(Number1, Number2 float64) float64 { \treturn Number1 / Number2 }  /* 工厂 */  // Operators 注册所有支持的运算 var Operators = map[string]Operation { \t\"+\": Add, \t\"-\": Sub, \t\"*\": Mul, \t\"/\": Div, }  // CreateOperation 通过 string 表示的 operator 获取适合的 Operation 函数 func CreateOperation(operator string) (Operation, error) { \tvar oper Operation \tif oper, ok := Operators[operator]; ok { \treturn oper, nil \t} \treturn oper, errors.New(\"Illegal Operator\") } HTTP 接下来是 RPC 服务的实现，在 server.go 中，与calc.go为同一个package：\n// server.go // RPC 服务实现  // CalcService 是计算器 RPC 服务的实现 type CalcService struct{}  // CalcTwoNumber 对两个数进行加减乘除运算 func (c *CalcService) CalcTwoNumber(request calc.Calc, reply *float64) error { \t// 因为在同一个 package 下，可以直接读取 calc.go 里的函数 \toper, err := CreateOperation(request.Operator) \tif err != nil { \treturn err \t} \t*reply = oper(request.Number1, request.Number2) \treturn nil }  // GetOperators 获取所有支持的运算 func (c *CalcService) GetOperators(request struct{}, reply *[]string) error { \topers := make([]string, 0, len(Operators)) \tfor key := range Operators { \topers = append(opers, key) \t} \t*reply = opers \treturn nil }  /* 运行 RPC 服务 */  func main() { \tcalc.RegisterCalcService(new(CalcService)) \trpc.HandleHTTP() \thttp.ListenAndServe(\":8080\", nil) } 使用go run .来运行。\n客户端 // client.go  /* 定义客户端实现 */  // CalcClient is a client for CalcService type CalcClient struct { \t*rpc.Client }  var _ calc.ServiceInterface = (*CalcClient)(nil)  // DialCalcService dial CalcService func DialCalcService(network, address string) (*CalcClient, error) { \tc, err := rpc.DialHTTP(network, address) \tif err != nil { \treturn nil, err \t} \treturn \u0026CalcClient{Client: c}, nil }  // CalcTwoNumber 对两个数进行运算 func (c *CalcClient) CalcTwoNumber(request calc.Calc, reply *float64) error { \treturn c.Client.Call(calc.ServiceName+\".CalcTwoNumber\", request, reply) }  // GetOperators 获取所有支持的运算 func (c *CalcClient) GetOperators(request struct{}, reply *[]string) error { \treturn c.Client.Call(calc.ServiceName+\".GetOperators\", request, reply) }  /* 使用客户端调用 RPC 服务 */  func main() { \tclient, err := DialCalcService(\"tcp\", \"localhost:8080\") \tif err != nil { \tlog.Fatal(\"Err Dial Client:\", err) \t}  \t// Test GetOperators \tvar opers []string \terr = client.GetOperators(struct{}{}, \u0026opers) \tif err != nil { \tlog.Println(err) \t} \tlog.Println(opers)  \t// Test CalcTwoNumber \ttestAdd := calc.Calc{ \tNumber1: 2.0, \tNumber2: 3.14, \tOperator: \"+\", \t} \tvar result float64 \tclient.CalcTwoNumber(testAdd, \u0026result) \tlog.Println(result) } TCP 如果使用TCP协议的话可以改其中部分代码，注意观察其中的区别：\n// server.go  func main() { \tcalc.RegisterCalcService(new(CalcService)) \t /* HTTP */  // rpc.HandleHTTP()  // http.ListenAndServe(\":8080\", nil) \t /* TCP */  listener, err := net.Listen(\"tcp\", \":8080\") \tif err != nil { \tlog.Fatal(\"ListenTCP error:\", err) \t}  \tfor { \tconn, err := listener.Accept() \tif err != nil { \tlog.Fatal(\"Accept error:\", err) \t}  \tgo rpc.ServeConn(conn) \t} } // client.go  /* HTTP */ // DialCalcService dial CalcService // func DialCalcService(network, address string) (*CalcClient, error) { // c, err := rpc.DialHTTP(network, address) // if err != nil { // return nil, err // } // return \u0026CalcClient{Client: c}, nil // }  /* TCP */ func DialCalcService(network, address string) (*CalcClient, error) { \tc, err := rpc.Dial(network, address) \tif err != nil { \treturn nil, err \t} \treturn \u0026CalcClient{Client: c}, nil } 4. 跨语言的 RPC 服务 TCP net/rpc/jsonrpc 就是这样的一种实现，它使用 JSON 而不是 Gob 编码，可以用来做跨语言 RPC。在真实的使用中，net/rpc/jsonrpc 在内部封装了上面提到的编码、解码实现，提供大致上和 net/rpc 相同的 API。\n服务端 服务端在之前的 Hello World 基础上，只需要改动 main 的最后一行代码即可变为使用 JSON RPC：\n// server.go  // Instead of `go rpc.ServeConn(conn)` go jsonrpc.ServeConn(conn)  // jsonrpc.ServeConn 的实现是 rpc.ServeCodec(jsonrpc.NewServerCodec(conn))，所以也可以用 go rpc.ServeCodec(jsonrpc.NewServerCodec(conn)) 客户端 在调用时，将 DialHelloService 中连接服务的代码改一改就可以使用了：\n// client.go  // Instead of `c, err := rpc.Dial(network, address)` c, err := jsonrpc.Dial(\"tcp\", \"localhost:1234\")  // 也可以用 conn, _ := net.Dial(\"tcp\", \"localhost:1234\") client := rpc.NewClientWithCodec(jsonrpc.NewClientCodec(conn)) 我们可以看到程序发出和接收到的JSON信息格式，在这之前我们先了解一下 nc 命令和 echo 命令：\n# nc，全名叫 netcat，它可以用来完成很多的网络功能，譬如端口扫描、建立TCP/UDP连接，数据传输、网络调试等等 $ nc [-hlnruz][-g][-G][-i][-o][-p][-s][-v...][-w][主机名称][通信端口...]  # 想要连接到某处[发送]:  $ nc [-options] hostname port[s] [ports] …  # 绑定端口等待连接[接收]:  $ nc -l port [-options] [hostname] [port]  # echo 就是输出命令 $ echo [选项] [输出内容]：输出命令 # -e：支持反斜线控制的字符转换 我们可以关闭服务端程序，运行 nc -l 1234 启动一个 TCP 服务，然后再次运行客户端程序，nc 会输出客户端请求的内容：\n$ nc -l 1234 # {\"method\":\"HelloService.Hello\",\"params\":[\"world\"],\"id\":0} 可以看到请求体是 JSON 数据。反过来，模仿这个请求体，我们可以手动向正在运行的客户端发送模拟请求，查看响应体：\n$ echo -e '{\"method\":\"HelloService.Hello\",\"params\":[\"JSON-RPC\"],\"id\":1}' | nc localhost 1234 # {\"id\":1,\"result\":\"Hello, JSON-RPC\",\"error\":null} 总结，请求、响应的结构体大概为：\ntype Request struct {  Method string `json:\"method\"`  Params *json.RawMessage `json:\"params\"`  Id *json.RawMessage `json:\"id\"` } // method：对应要调用的由 RPC 服务和方法组合成额度名字 // params：第一个元素为参数 // id：由调用方维护的唯一的调用编号  type Response struct {  Id uint64 `json:\"id\"`  Result *json.RawMessage `json:\"result\"`  Error interface{} `json:\"error\"` } // id：对应输入的id参数 // result：返回的结果 // error：错误信息 Go语言的 RPC 框架支持异步调用，当返回结果的顺序和调用的顺序不一致时，可以通过 id 来识别对应的调用。\n使用其他语言，只要遵循这样的请求/响应结构，就可以和 Go 的 RPC 服务进行通信了。\nHTTP 服务端 net/rpc 的 RPC 服务是建立在抽象的 io.ReadWriteCloser 接口之上的（conn），所以略作改变，就可以将 RPC 架设在不同的通讯协议之上。这里我们将尝试将 net/rpc/jsonrpc 架设到 HTTP 服务上：\nfunc main() { \tRegisterHelloService(new(HelloService))  \t// HTTP 服务 \thttp.HandleFunc(\"/jsonrpc\", func(w http.ResponseWriter, r *http.Request) { \tvar conn io.ReadWriteCloser = struct { \tio.Writer \tio.ReadCloser \t} { \tReadCloser: r.Body, \tWriter: w, \t}  \trpc.ServeRequest(jsonrpc.NewServerCodec(conn)) \t})  \thttp.ListenAndServe(\":1234\", nil) } 然后就可以通过 HTTP 很方便地从不同的语言中访问 RPC 服务了：\n$ curl -X POST http://localhost:1234/jsonrpc --data '{\"method\":\"HelloService.Hello\",\"params\":[\"world\"],\"id\":0}' # {\"id\":0,\"result\":\"Hello, world\",\"error\":null} 客户端 TODO：\n不方便使用 Go 写客户端，你需要自己去构建一个客户端实现，来完成请求的编码、发送以及响应的解码、绑定；或者可以使用一个 JSON-RPC 的库。\n",
  "wordCount" : "1441",
  "inLanguage": "en",
  "datePublished": "2022-12-13T10:52:29+08:00",
  "dateModified": "2022-12-13T10:52:29+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://perhapzz.github.io/posts/firststepofrpc/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "perhapzz",
    "logo": {
      "@type": "ImageObject",
      "url": "https://perhapzz.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://perhapzz.github.io" accesskey="h" title="perhapzz (Alt + H)">perhapzz</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://perhapzz.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://perhapzz.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://perhapzz.github.io">Home</a>&nbsp;»&nbsp;<a href="https://perhapzz.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      迈出Go RPC的一小步
    </h1>
    <div class="post-description">
      记Go语言远程过程调用RPC学习过程
    </div>
    <div class="post-meta"><span title='2022-12-13 10:52:29 +0800 CST'>December 13, 2022</span>

</div>
  </header> 
  <div class="post-content"><p>参考：<a href="https://juejin.cn/post/6987221045493268510">用Go语言从零开始撸一套RPC</a></p>
<h1 id="0-新建一个go项目">0. 新建一个Go项目<a hidden class="anchor" aria-hidden="true" href="#0-新建一个go项目">#</a></h1>
<p>因为好久没写go了，所以这也算一步吧&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 新建一个目录</span>
</span></span><span style="display:flex;"><span>$ mkdir HandsOnGoRPC
</span></span><span style="display:flex;"><span>$ cd HandsOnGoRPC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化并写入一个新的go.mod至当前目录中，实际上是创建一个以当前目录为根的新模块。</span>
</span></span><span style="display:flex;"><span>$ go mod init
</span></span><span style="display:flex;"><span>$ go mod tidy
</span></span></code></pre></div><p>另外再顺便上个git</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ git init
</span></span><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#34;initial commit&#34;</span>
</span></span><span style="display:flex;"><span>$ git remote add origin https://github.com/perhapzz/HandsOnGoRPC.git
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 带上-u 参数其实就相当于记录了push到远端分支的默认值，这样当下次我们还想要继续push的这个远端分支的时候推送命令就可以简写成git push即可</span>
</span></span><span style="display:flex;"><span>$ git push -u origin main
</span></span></code></pre></div><h1 id="1-hello-rpc">1. Hello RPC<a hidden class="anchor" aria-hidden="true" href="#1-hello-rpc">#</a></h1>
<h2 id="描述">描述<a hidden class="anchor" aria-hidden="true" href="#描述">#</a></h2>
<p>对于服务端， <code>net/rpc</code> 要求用一个导出的结构体来表示 RPC 服务，这个结构体中所有符合特定要求的方法就是提供给客户端访问的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">T</span> <span style="color:#66d9ef">struct</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">T</span>) <span style="color:#a6e22e">MethodName</span>(<span style="color:#a6e22e">argType</span> <span style="color:#a6e22e">T1</span>, <span style="color:#a6e22e">replyType</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">T2</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 结构体是导出的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法是导出的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法有两个参数，都是导出的类型（或者内置类型）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法的第二个参数是指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 方法的返回值是 error
</span></span></span></code></pre></div><p>服务端通过 <code>rpc.Dial</code>（对 TCP 服务）连接服务端，然后用使用 <code>Call</code> 调用 RPC 服务中的方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#e6db74">&#34;T.MethodName&#34;</span>, <span style="color:#a6e22e">argType</span> <span style="color:#a6e22e">T1</span>, <span style="color:#a6e22e">replyType</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">T2</span>)
</span></span></code></pre></div><h2 id="代码">代码<a hidden class="anchor" aria-hidden="true" href="#代码">#</a></h2>
<h3 id="服务端">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// server.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloService is a RPC service for helloWorld
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloService</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Hello say hello to request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloService</span>) <span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">reply</span> = <span style="color:#e6db74">&#34;hello:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 用将给客户端访问的名字和HelloService实例注册 RPC 服务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">RegisterName</span>(<span style="color:#e6db74">&#34;HelloService&#34;</span>, new(<span style="color:#a6e22e">HelloService</span>))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TCP 服务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:1234&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;ListenTCP error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Accept error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 上述代码只 Accept 一个请求，在客户端请求过后就会自动关闭。如果需要一直保持处理，可以把后半部分代码换成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// for {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	conn, err := listener.Accept()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	if err != nil {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 		log.Fatal(&#34;Accept error:&#34;, err)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	// 开一个协程处理连接上的接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	go rpc.ServeConn(conn)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>对于循环监听，我的理解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 开始监听
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 接收到请求开始进行后续程序
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Accept error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 开一个协程处理连接上的接口，主程序监听下一次请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><h3 id="客户端">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// client.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/rpc&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:1234&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;dialing:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#e6db74">&#34;HelloService.Hello&#34;</span>, <span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="2-更规范的rpc接口">2. 更规范的RPC接口<a hidden class="anchor" aria-hidden="true" href="#2-更规范的rpc接口">#</a></h1>
<h2 id="描述-1">描述<a hidden class="anchor" aria-hidden="true" href="#描述-1">#</a></h2>
<p>之前的代码服务端、客户端的注册、调用 RPC 服务都是写死的。所有的工作都放到了一块，相当不利于维护，需要考虑重构 HelloService 服务和客户端实现。</p>
<p>我们将RPC服务的接口规范分为3部分：</p>
<ol>
<li>服务的名字</li>
<li>服务要实现的详细方法列表</li>
<li>注册该类型服务的函数</li>
</ol>
<p>在客户端上也要针对HelloService服务的借口，做针对性的Client类型，这样客户端用户可以直接通过接口对应的方法调用RPC函数，同时提供<code>DialHelloService()</code>函数，直接拨号HelloService服务。</p>
<p>客户的接口规范：</p>
<ol>
<li>客户的名字，包含一个<code>*rpc.Client</code></li>
<li>直接拨号指定服务的函数</li>
<li>客户直接调用指定方法的函数</li>
</ol>
<p>这样做避免了RPC方法名字或参数类型不匹配等低级错误的发生，具体调用时也不用暴露处理 RPC 的细节了。</p>
<h2 id="代码-1">代码<a hidden class="anchor" aria-hidden="true" href="#代码-1">#</a></h2>
<h3 id="服务端-1">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端-1">#</a></h3>
<p>使用<code>RegisterHelloService()</code>函数来注册函数，这样不仅可以避免命名服务名称的工作，同时也保证了传入的服务对象满足RPC接口的定义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// server.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloService</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloService</span>) <span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">reply</span> = <span style="color:#e6db74">&#34;hello:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloServiceName is the name of HelloService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">HelloServiceName</span> = <span style="color:#e6db74">&#34;HelloService&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloServiceInterface is a interface for HelloService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloServiceInterface</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RegisterHelloService register the RPC service on svc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RegisterHelloService</span>(<span style="color:#a6e22e">svc</span> <span style="color:#a6e22e">HelloServiceInterface</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 返回rpc.RegisterName(HelloServiceName, svc)的报错信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">RegisterName</span>(<span style="color:#a6e22e">HelloServiceName</span>, <span style="color:#a6e22e">svc</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// rpc.RegisterName(&#34;HelloService&#34;, new(HelloService))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RegisterHelloService</span>(new(<span style="color:#a6e22e">HelloService</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:1234&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;ListenTCP error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Accept error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>新的服务改为支持多个TCP链接，然后为每个TCP链接提供RPC服务。</p>
<h3 id="客户端-1">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端-1">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// client.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloServiceName is the name of HelloService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">HelloServiceName</span> = <span style="color:#e6db74">&#34;HelloService&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloServiceClient is a client for HelloService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloServiceClient</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Client</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloServiceInterface is a interface for HelloService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloServiceInterface</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 测试接口定义
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">HelloServiceInterface</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloServiceClient</span>)(<span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DialHelloService dial HelloService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 针对 HelloService 设计 Client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DialHelloService</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">HelloServiceClient</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">HelloServiceClient</span>{<span style="color:#a6e22e">Client</span>: <span style="color:#a6e22e">c</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Hello calls HelloService.Hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 针对 HelloService 各个服务设计 Call 函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloServiceClient</span>) <span style="color:#a6e22e">Hello</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">HelloServiceName</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.Hello&#34;</span>, <span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DialHelloService</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:1234&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;dialing:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Hello</span>(<span style="color:#e6db74">&#34;world&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>但我也没感觉这样更清爽，在服务端和客户端都定义了<code>HelloServiceName</code>和<code>HelloServiceInterface</code>，有点冗余。</p>
<h1 id="3-计算器-rpc-服务">3. 计算器 RPC 服务<a hidden class="anchor" aria-hidden="true" href="#3-计算器-rpc-服务">#</a></h1>
<h2 id="描述-2">描述<a hidden class="anchor" aria-hidden="true" href="#描述-2">#</a></h2>
<p>用 RPC 服务实现一个计算器。</p>
<p>因为服务端和客户端都需要定义RPC接口，那么可以写一个通用的，然后import进去。另外所有服务要实现的详细方法都在<code>calc.go</code>里定义，<code>server.go</code>和<code>client.go</code>只写 RPC 服务的实现和调用，使代码结构更清晰。</p>
<h2 id="代码-2">代码<a hidden class="anchor" aria-hidden="true" href="#代码-2">#</a></h2>
<p>项目目录如下：</p>
<pre tabindex="0"><code>calc/
├── calcrpc.go
├── client
│   └── client.go
└── server
    ├── calc.go
    └── server.go
</code></pre><p>首先写一个 <code>calcrpc.go</code> 定义服务端/客户端通用的 RPC 接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// calcrpc.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 定义 ClacService 的名字、详细方法列表和注册该类型服务的函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ServiceName 计算器服务名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ServiceName</span> = <span style="color:#e6db74">&#34;CalcService&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ServiceInterface 计算器服务接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ServiceInterface</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// CalcTwoNumber 对两个数进行运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CalcTwoNumber</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">Calc</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GetOperators 获取所有支持的运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetOperators</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span>[]<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RegisterCalcService register the RPC service on svc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RegisterCalcService</span>(<span style="color:#a6e22e">svc</span> <span style="color:#a6e22e">ServiceInterface</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">RegisterName</span>(<span style="color:#a6e22e">ServiceName</span>, <span style="color:#a6e22e">svc</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Calc 定义计算器对象，包括两个运算数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Calc</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Number1</span>  <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Number2</span>  <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Operator</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="服务端-2">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端-2">#</a></h3>
<p>在 <code>calc.go</code> 中写一个常规的计算器抽象实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// calc.go 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 实现简单计算器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 抽象的计算函数类型 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Operation 是计算的抽象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 定义长 func(Number1, Number2 float64) float64 这样的可以用 Operation 来代替，并且是导出的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Operation</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">Number1</span>, <span style="color:#a6e22e">Number2</span> <span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 加减乘除的具体 Operation 实现 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Add 是加法的 Operation 实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">Number1</span>, <span style="color:#a6e22e">Number2</span> <span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Number1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">Number2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Sub 是减法的 Operation 实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">Number1</span>, <span style="color:#a6e22e">Number2</span> <span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Number1</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">Number2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Mul 是乘法的 Operation 实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Mul</span>(<span style="color:#a6e22e">Number1</span>, <span style="color:#a6e22e">Number2</span> <span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Number1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">Number2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Div 是除法的 Operation 实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Div</span>(<span style="color:#a6e22e">Number1</span>, <span style="color:#a6e22e">Number2</span> <span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">float64</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Number1</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">Number2</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 工厂 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Operators 注册所有支持的运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Operators</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">Operation</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;+&#34;</span>: <span style="color:#a6e22e">Add</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;-&#34;</span>: <span style="color:#a6e22e">Sub</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;*&#34;</span>: <span style="color:#a6e22e">Mul</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;/&#34;</span>: <span style="color:#a6e22e">Div</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// CreateOperation 通过 string 表示的 operator 获取适合的 Operation 函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateOperation</span>(<span style="color:#a6e22e">operator</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">Operation</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">oper</span> <span style="color:#a6e22e">Operation</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">oper</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Operators</span>[<span style="color:#a6e22e">operator</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">oper</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">oper</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Illegal Operator&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="http">HTTP<a hidden class="anchor" aria-hidden="true" href="#http">#</a></h4>
<p>接下来是 RPC 服务的实现，在 <code>server.go</code> 中，与<code>calc.go</code>为同一个package：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// server.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// RPC 服务实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// CalcService 是计算器 RPC 服务的实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CalcService</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// CalcTwoNumber 对两个数进行加减乘除运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CalcService</span>) <span style="color:#a6e22e">CalcTwoNumber</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">Calc</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 因为在同一个 package 下，可以直接读取 calc.go 里的函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">oper</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateOperation</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Operator</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">reply</span> = <span style="color:#a6e22e">oper</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Number1</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Number2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetOperators 获取所有支持的运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CalcService</span>) <span style="color:#a6e22e">GetOperators</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span>[]<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opers</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">Operators</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">Operators</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">opers</span> = append(<span style="color:#a6e22e">opers</span>, <span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">reply</span> = <span style="color:#a6e22e">opers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 运行 RPC 服务 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">RegisterCalcService</span>(new(<span style="color:#a6e22e">CalcService</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">HandleHTTP</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用<code>go run .</code>来运行。</p>
<h3 id="客户端-2">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端-2">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// client.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 定义客户端实现 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// CalcClient is a client for CalcService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CalcClient</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Client</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">ServiceInterface</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">CalcClient</span>)(<span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DialCalcService dial CalcService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DialCalcService</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CalcClient</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">DialHTTP</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CalcClient</span>{<span style="color:#a6e22e">Client</span>: <span style="color:#a6e22e">c</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// CalcTwoNumber 对两个数进行运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CalcClient</span>) <span style="color:#a6e22e">CalcTwoNumber</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">Calc</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">float64</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">ServiceName</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.CalcTwoNumber&#34;</span>, <span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetOperators 获取所有支持的运算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CalcClient</span>) <span style="color:#a6e22e">GetOperators</span>(<span style="color:#a6e22e">request</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span>[]<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">ServiceName</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.GetOperators&#34;</span>, <span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 使用客户端调用 RPC 服务 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DialCalcService</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:8080&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Err Dial Client:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Test GetOperators
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opers</span> []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">GetOperators</span>(<span style="color:#66d9ef">struct</span>{}{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">opers</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">opers</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Test CalcTwoNumber
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">testAdd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">Calc</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Number1</span>:  <span style="color:#ae81ff">2.0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Number2</span>:  <span style="color:#ae81ff">3.14</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Operator</span>: <span style="color:#e6db74">&#34;+&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CalcTwoNumber</span>(<span style="color:#a6e22e">testAdd</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="tcp">TCP<a hidden class="anchor" aria-hidden="true" href="#tcp">#</a></h4>
<p>如果使用TCP协议的话可以改其中部分代码，注意观察其中的区别：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// server.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">calc</span>.<span style="color:#a6e22e">RegisterCalcService</span>(new(<span style="color:#a6e22e">CalcService</span>))
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* HTTP */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// rpc.HandleHTTP()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// http.ListenAndServe(&#34;:8080&#34;, nil)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* TCP */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:8080&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;ListenTCP error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Accept error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// client.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* HTTP */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// DialCalcService dial CalcService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// func DialCalcService(network, address string) (*CalcClient, error) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 	c, err := rpc.DialHTTP(network, address)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 	if err != nil {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 		return nil, err
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 	}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 	return &amp;CalcClient{Client: c}, nil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* TCP */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DialCalcService</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">CalcClient</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CalcClient</span>{<span style="color:#a6e22e">Client</span>: <span style="color:#a6e22e">c</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="4-跨语言的-rpc-服务">4. 跨语言的 RPC 服务<a hidden class="anchor" aria-hidden="true" href="#4-跨语言的-rpc-服务">#</a></h1>
<h2 id="tcp-1">TCP<a hidden class="anchor" aria-hidden="true" href="#tcp-1">#</a></h2>
<p><code>net/rpc/jsonrpc</code> 就是这样的一种实现，它使用 JSON 而不是 Gob 编码，可以用来做跨语言 RPC。在真实的使用中，<code>net/rpc/jsonrpc</code> 在内部封装了上面提到的编码、解码实现，提供大致上和 <code>net/rpc</code> 相同的 API。</p>
<h3 id="服务端-3">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端-3">#</a></h3>
<p>服务端在之前的 Hello World 基础上，只需要改动 main 的最后一行代码即可变为使用 JSON RPC：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// server.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Instead of `go rpc.ServeConn(conn)`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// jsonrpc.ServeConn 的实现是 rpc.ServeCodec(jsonrpc.NewServerCodec(conn))，所以也可以用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">ServeCodec</span>(<span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">NewServerCodec</span>(<span style="color:#a6e22e">conn</span>))
</span></span></code></pre></div><h3 id="客户端-3">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端-3">#</a></h3>
<p>在调用时，将 <code>DialHelloService</code> 中连接服务的代码改一改就可以使用了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// client.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Instead of `c, err := rpc.Dial(network, address)`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:1234&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 也可以用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:1234&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">NewClientWithCodec</span>(<span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">NewClientCodec</span>(<span style="color:#a6e22e">conn</span>))
</span></span></code></pre></div><p>我们可以看到程序发出和接收到的JSON信息格式，在这之前我们先了解一下 <code>nc</code> 命令和 <code>echo</code> 命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># nc，全名叫 netcat，它可以用来完成很多的网络功能，譬如端口扫描、建立TCP/UDP连接，数据传输、网络调试等等</span>
</span></span><span style="display:flex;"><span>$ nc <span style="color:#f92672">[</span>-hlnruz<span style="color:#f92672">][</span>-g&lt;网关...&gt;<span style="color:#f92672">][</span>-G&lt;指向器数目&gt;<span style="color:#f92672">][</span>-i&lt;延迟秒数&gt;<span style="color:#f92672">][</span>-o&lt;输出文件&gt;<span style="color:#f92672">][</span>-p&lt;通信端口&gt;<span style="color:#f92672">][</span>-s&lt;来源位址&gt;<span style="color:#f92672">][</span>-v...<span style="color:#f92672">][</span>-w&lt;超时秒数&gt;<span style="color:#f92672">][</span>主机名称<span style="color:#f92672">][</span>通信端口...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 想要连接到某处[发送]: </span>
</span></span><span style="display:flex;"><span>$ nc <span style="color:#f92672">[</span>-options<span style="color:#f92672">]</span> hostname port<span style="color:#f92672">[</span>s<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>ports<span style="color:#f92672">]</span> …
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绑定端口等待连接[接收]: </span>
</span></span><span style="display:flex;"><span>$ nc -l port <span style="color:#f92672">[</span>-options<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>hostname<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>port<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo 就是输出命令</span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#f92672">[</span>选项<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>输出内容<span style="color:#f92672">]</span>：输出命令
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -e：支持反斜线控制的字符转换</span>
</span></span></code></pre></div><p>我们可以关闭服务端程序，运行 <code>nc -l 1234</code> 启动一个 TCP 服务，然后再次运行客户端程序，nc 会输出客户端请求的内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nc -l <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;method&#34;:&#34;HelloService.Hello&#34;,&#34;params&#34;:[&#34;world&#34;],&#34;id&#34;:0}</span>
</span></span></code></pre></div><p>可以看到请求体是 JSON 数据。反过来，模仿这个请求体，我们可以手动向正在运行的客户端发送模拟请求，查看响应体：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo -e <span style="color:#e6db74">&#39;{&#34;method&#34;:&#34;HelloService.Hello&#34;,&#34;params&#34;:[&#34;JSON-RPC&#34;],&#34;id&#34;:1}&#39;</span> | nc localhost <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;id&#34;:1,&#34;result&#34;:&#34;Hello, JSON-RPC&#34;,&#34;error&#34;:null}</span>
</span></span></code></pre></div><p>总结，请求、响应的结构体大概为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Method</span> <span style="color:#66d9ef">string</span>           <span style="color:#e6db74">`json:&#34;method&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Params</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">RawMessage</span> <span style="color:#e6db74">`json:&#34;params&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Id</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">RawMessage</span> <span style="color:#e6db74">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// method：对应要调用的由 RPC 服务和方法组合成额度名字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// params：第一个元素为参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// id：由调用方维护的唯一的调用编号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Response</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Id</span>     <span style="color:#66d9ef">uint64</span>           <span style="color:#e6db74">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Result</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">RawMessage</span> <span style="color:#e6db74">`json:&#34;result&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Error</span>  <span style="color:#66d9ef">interface</span>{}      <span style="color:#e6db74">`json:&#34;error&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// id：对应输入的id参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// result：返回的结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// error：错误信息
</span></span></span></code></pre></div><p>Go语言的 RPC 框架支持异步调用，当返回结果的顺序和调用的顺序不一致时，可以通过 id 来识别对应的调用。</p>
<p>使用其他语言，只要遵循这样的请求/响应结构，就可以和 Go 的 RPC 服务进行通信了。</p>
<h2 id="http-1">HTTP<a hidden class="anchor" aria-hidden="true" href="#http-1">#</a></h2>
<h3 id="服务端-4">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端-4">#</a></h3>
<p><code>net/rpc</code> 的 RPC 服务是建立在抽象的 <code>io.ReadWriteCloser</code> 接口之上的（conn），所以略作改变，就可以将 RPC 架设在不同的通讯协议之上。这里我们将尝试将 <code>net/rpc/jsonrpc</code> 架设到 HTTP 服务上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RegisterHelloService</span>(new(<span style="color:#a6e22e">HelloService</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// HTTP 服务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/jsonrpc&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadWriteCloser</span> = <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadCloser</span>
</span></span><span style="display:flex;"><span>		} {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadCloser</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Body</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Writer</span>: <span style="color:#a6e22e">w</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">ServeRequest</span>(<span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">NewServerCodec</span>(<span style="color:#a6e22e">conn</span>))
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:1234&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后就可以通过 HTTP 很方便地从不同的语言中访问 RPC 服务了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -X POST http://localhost:1234/jsonrpc  --data <span style="color:#e6db74">&#39;{&#34;method&#34;:&#34;HelloService.Hello&#34;,&#34;params&#34;:[&#34;world&#34;],&#34;id&#34;:0}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;id&#34;:0,&#34;result&#34;:&#34;Hello, world&#34;,&#34;error&#34;:null}</span>
</span></span></code></pre></div><h3 id="客户端-4">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端-4">#</a></h3>
<p><strong>TODO：</strong></p>
<p>不方便使用 Go 写客户端，你需要自己去构建一个客户端实现，来完成请求的编码、发送以及响应的解码、绑定；或者可以使用一个 JSON-RPC 的库。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://perhapzz.github.io/tags/golang/">golang</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://perhapzz.github.io">perhapzz</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
